---
title: Docker Volumes
categories:
  - docker
  - notes
tags:
  - docker
  - volume
date: 2018-12-5 10:23:09
series: docker
---

### Introduction

> **Volumes are the preferred mechanism for persisting data generated by and used by Docker containers.** While [bind mounts](https://docs.docker.com/storage/bind-mounts/) are dependent on the directory structure of the host machine, **volumes are completely managed by Docker**. Volumes have several advantages over bind mounts:
>
> - Volumes are easier to back up or migrate than bind mounts.
> - You can manage volumes using Docker CLI commands or the Docker API.
> - Volumes work on both Linux and Windows containers.
> - Volumes can be more safely shared among multiple containers.
> - Volume drivers let you store volumes on remote hosts or cloud providers, to encrypt the contents of volumes, or to add other functionality.
> - New volumes can have their content pre-populated by a container.
>
> In addition, volumes are often a better choice than persisting data in a container’s writable layer, because a volume does not increase the size of the containers using it, and the volume’s contents exist outside the lifecycle of a given container.
>
> ![volumes on the Docker host](https://docs.docker.com/storage/images/types-of-mounts-volume.png)
>
> If your container generates non-persistent state data, consider using a [tmpfs mount](https://docs.docker.com/storage/tmpfs/) to avoid storing the data anywhere permanently, and to increase the container’s performance by avoiding writing into the container’s writable layer.
>
> Volumes use `rprivate` bind propagation, and bind propagation is not configurable for volumes.

### Use volumes with `-v` and `--mount` flag

There is two ways we could use volume on our target, with `-v` or `--volum` flag, or with `--mount` flag.

In general, `--mount` is more explicit and verbose, but it was available for standalone containers since Docker 17.06, before that it only use on swarm services. And the `-v` flag only support for container, not for services.

The biggest difference is that the `-v` or `--volume` syntax combines all the options together **in one field**, while the `--mount` syntax separates them.

If you need to specify volume driver options, you must use `--mount`.

- `-v` or `--volume` : Consists of three fields, separated by colon characters (`:`). The fields must be in the correct order, and the meaning of each field is not immediately obvious.

  - In the case of named volumes, the first field is the name of the volume, and is unique on a given host machine. For anonymous volumes, the first field is omitted.
  - The second field is the path where the file or directory are mounted in the container.
  - The third field is optional, and is a comma-separated list of options, such as `ro`. These options are discussed below.

- `--mount` : Consists of multiple key-value pairs, separated by commas and each consisting of a `<key>=<value>`tuple. The`--mount`syntax is more verbose than`-v` or `--volume`, but the order of the keys is not significant, and the value of the flag is easier to understand.

  - The `type` of the mount, which can be [`bind`](https://docs.docker.com/storage/bind-mounts/), `volume`, or [`tmpfs`](https://docs.docker.com/storage/tmpfs/). This topic discusses volumes, so the type is always`volume`.
  - The `source` of the mount. For named volumes, this is the name of the volume. For anonymous volumes, this field is omitted. May be specified as `source` or `src`.
  - The `destination` takes as its value the path where the file or directory is mounted in the container. May be specified as `destination`, `dst`, or `target`.
  - The `readonly` option, if present, causes the bind mount to be [mounted into the container as read-only](https://docs.docker.com/storage/volumes/#use-a-read-only-volume).
  - The `volume-opt` option, which can be specified more than once, takes a key-value pair consisting of the option name and its value.

> At this article, I just show the `--mount` flag.

### Create and manage volumes

- create

  ```bash
  $ docker volume create my-vol
  ```

- list volumes

  ```bash
  $ docker volume ls
  ```

- inspect volume

  ```bash
  $ docker volume inspect my-vol
  [
      {
          "Driver": "local",
          "Labels": {},
          "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",
          "Name": "my-vol",
          "Options": {},
          "Scope": "local"
      }
  ]
  ```

- remove volume

  ```bash
  $ docker volume rm my-vol
  ```

### Use case

If you start a container with a volume that does not yet exist, Docker creates the volume for you. The following example mounts the volume `myvol2` into `/app/` in the container.

The `-v` and `--mount` examples below produce the same result. You can’t run them both unless you remove the `devtest` container and the `myvol2` volume after running the first one.

#### Start with container

```bash
$ docker run -d \
  --name devtest \
  --mount source=myvol2,target=/app \
  nginx:latest
```

Use `docker inspect devtest` to verify that the volume was created and mounted correctly. Look for the `Mounts` section:

```bash
"Mounts": [
    {
        "Type": "volume",
        "Name": "myvol2",
        "Source": "/var/lib/docker/volumes/myvol2/_data",
        "Destination": "/app",
        "Driver": "local",
        "Mode": "",
        "RW": true,
        "Propagation": ""
    }
],
```

This shows that the mount is a volume, it shows the correct source and destination, and that the mount is read-write.

Stop the container and remove the volume. Note volume removal is a separate step.

```bash
$ docker container stop devtest

$ docker container rm devtest

$ docker volume rm myvol2
```

#### Start with service

When you start a service and define a volume, each service container uses its own local volume. None of the containers can share this data if you use the `local` volume driver, but some volume drivers do support shared storage. Docker for AWS and Docker for Azure both support persistent storage using the Cloudstor plugin.

The following example starts a `nginx` service with four replicas, each of which uses a local volume called `myvol2`.

```bash
$ docker service create -d \
  --replicas=4 \
  --name devtest-service \
  --mount source=myvol2,target=/app \
  nginx:latest
```

Use `docker service ps devtest-service` to verify that the service is running:

```bash
$ docker service ps devtest-service

ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
4d7oz1j85wwn        devtest-service.1   nginx:latest        moby                Running             Running 14 seconds ago
```

Remove the service, which stops all its tasks:

```bash
$ docker service rm devtest-service
```

Removing the service does not remove any volumes created by the service. Volume removal is a separate step.

#### Populate a volume using a container

If you start a container which creates a new volume, as above, and the container has files or directories in the directory to be mounted (such as `/app/` above), the directory’s contents are copied into the volume. The container then mounts and uses the volume, and other containers which use the volume also have access to the pre-populated content.

To illustrate this, this example starts an `nginx` container and populates the new volume `nginx-vol` with the contents of the container’s `/usr/share/nginx/html` directory, which is where Nginx stores its default HTML content.

The `--mount` and `-v` examples have the same end result.

```bash
$ docker run -d \
  --name=nginxtest \
  --mount source=nginx-vol,destination=/usr/share/nginx/html \
  nginx:latest
```

After running either of these examples, run the following commands to clean up the containers and volumes. Note volume removal is a separate step.

```bash
$ docker container stop nginxtest

$ docker container rm nginxtest

$ docker volume rm nginx-vol
```

#### Read-only

Because the volume could be mount at multiple containers, so there might containers only needs read access to the data.

```bash
$ docker run -d \
  --name=nginxtest \
  --mount source=nginx-vol,destination=/usr/share/nginx/html,readonly \
  nginx:latest
```

### Other case

There are other use case on official doc like: **Share data among machines**, **Back up, restore, migrate data volumes** and so on.

You can check more information by refer to: https://docs.docker.com/storage/volumes
