<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script>
        if (location.hostname === 'youyinnn.github.io' && returnCitySN.cname === 'CHINA') {
            location.href = 'https://youyinnn.gitee.io' + location.pathname
        }
    </script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">


    <script src="/resources/resources.js"></script>
    <script src="/myjs/import.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg em-svg em-rocket"></button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <span id="slogan">
            <i id="wolf-logo" class="em-svg em-new_moon mr-4"></i>I'M BACK
        </span>
        <div id="showmore"> &gt; About Me & This Blog</div>
        <div id="showhacknical"> &gt; My Github Analysis</div>
        <div id="toarticles"> &gt; My Tech Articles</div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="series" class="unselectable">
        <span>系</span>
        <span>列</span>
        <span>文</span>
        <span>章</span>
    </div>
    <div id="seriesbox" class="unselectable">

    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistic</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Site running days:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Total article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Char count:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Category count:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tag count:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search">
            <div class="input-group-append">
                <button id="cleanbut" class="btn" type="button" title="clear search">cls</button>
                <button id="categories" class="btn" type="button">cates</button>
                <button id="tags" class="btn" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn" type="button" title="search">sch</button>
            </div>
        </div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3>
            <a name="_root-Introduction" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Introduction
          </h3><p>In the last post, we discussed the relationship between Application and Service. </p>
<p>So they say: <strong>Services are really just &quot;Containers in Production&quot;.</strong></p>
<p>And when we deploy a service, we use <code>docker swarm init</code> to prepare for it.</p>
<p>Now let&#39;s learn what is swarm and how to setup a cluster with <strong>docker-machine</strong>.</p>

          <h3>
            <a name="_root-Swarm" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Swarm
          </h3><p><strong>A swarm is a group of machines that are running Docker and joined into a cluster.</strong></p>
<p>After that has happened, you continue to run the Docker commands you’re used to, but now they are executed on a cluster by a <strong>swarm manager</strong>. The machines in a swarm can be <strong>physical or virtual</strong>. After joining a swarm, they are referred to as <strong>nodes</strong>.</p>
<p>Swarm managers can use several <strong>strategies</strong> to run containers, such as :</p>
<ul>
<li><p>“emptiest node” </p>
<p>  which fills the least utilized machines with containers.</p>
</li>
<li><p>“global”</p>
<p>  which ensures that each machine gets exactly one instance of the specified container. </p>
</li>
</ul>
<p>You instruct the swarm manager to use these strategies <strong>in the Compose file</strong>, just like the one you have already been using.</p>

          <h4>
            <a name="_root-Swarm manager" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Swarm manager
          </h4><p>Swarm managers are the only machines in a swarm that can execute your commands, or authorize other machines to join the swarm as <strong>workers</strong>. Workers are just there to provide capacity and do not have the authority to tell any other machine what it can and cannot do.</p>
<pre><code>Relationship in swarm:

    1.each virtual/physical machine as a &quot;node&quot; ni a swarm.
                            (node)            (node)            (node)
                               -------            -------            -------
      2.&quot;swarm init&quot; ---&gt;      |  A  |            |  B  |            |  C  |
       then A became          -------            -------            -------
       manager             &quot;swarm manager&quot;     &quot;worker&quot;        &quot;worker&quot;

    3.other nodes can &quot;join&quot; the swarm and became &quot;worker&quot; to work for the &quot;manager&quot;,
    &quot;manager&quot; certainly can manage it&#39;s &quot;workers&quot;</code></pre>
          <h3>
            <a name="_root-Setup your swarm with virtual machines" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Setup your swarm with virtual machines
          </h3><blockquote>
<p><strong>⚠️Notice:</strong></p>
<p>If your machine is a cloud server such as &quot;Tencent Cloud Server&quot;, you might couldn&#39;t able to create a vm on it.Because your machine is also a vm too ! There are some hardware options should support from a phycial machine.</p>
<p>But you can still follow the post and practice with it, on this section, you should focus on the concept of swarm and knowning how to create vms with <code>docker-machine</code>.</p>
</blockquote>
<p>So, how can we setup a swarm with multiple machine for just practice ? Several real machine ? No, you could create some virtual machine by <code>docker-machine</code>. Then use the as a node of swarm.</p>

          <h4>
            <a name="_root-Install VirtualBox" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Install VirtualBox
          </h4><p>You need a hypervisor that can create virtual machines (VMs), so <a href="https://www.virtualbox.org/wiki/Downloads">install Oracle VirtualBox</a> for your machine’s OS.</p>
<p>Some RPM base:</p>
<ul>
<li><a href="http://rpmfind.net/linux/RPM/index.html">rpmfind</a></li>
<li><a href="https://pkgs.org/">pkgs</a></li>
<li><a href="http://rpm.pbone.net/">pbone</a></li>
</ul>

          <h4>
            <a name="_root-Install docker-machine" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Install docker-machine
          </h4><blockquote>
<p><strong>Notice:</strong></p>
<p><strong>Never ever intall docker on WIN10 system !!! Because the <code>Hyper-V</code> that docker need will just weaken your machine&#39;s performance at some ways !!! Such as I found my LOL&#39;s fps rate was suddenly fall down to 58-61, and it usually was 100+ !!! And when I uninstall the docker on WIN10 then turn off the <code>Hyper-V</code> on windows functional options, the fps problem was solved !!!</strong> </p>
</blockquote>
<ol>
<li><p>download</p>
<pre><code class="language-bash"> $ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp; wget $base/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine</code></pre>
</li>
<li><p>install</p>
<pre><code class="language-bash"> $ install /tmp/docker-machine /usr/local/bin/docker-machine</code></pre>
</li>
<li><p>verify</p>
<pre><code class="language-bash"> $ docker-machine
 Usage: docker-machine [OPTIONS] COMMAND [arg...]
 Create and manage machines running Docker.
 Version: 0.16.0, build 702c267f
 ...</code></pre>
</li>
</ol>
<p>Reference: <a href="https://docs.docker.com/machine/install-machine/#install-machine-directly">https://docs.docker.com/machine/install-machine/#install-machine-directly</a></p>

          <h4>
            <a name="_root-Create virtual machines" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Create virtual machines
          </h4><p>Now, create a couple of VMs using <code>docker-machine</code>, using the VirtualBox driver:</p>
<pre><code class="language-bash">$ docker-machine create --driver virtualbox myvm1
$ docker-machine create --driver virtualbox myvm2</code></pre>
<p>You now have two VMs created, named <code>myvm1</code> and <code>myvm2</code>.</p>
<p>Use this command to list the machines and get their IP addresses.</p>
<pre><code class="language-bash">$ docker-machine ls</code></pre>
<p>Here is example output from this command.</p>
<pre><code class="language-bash">$ docker-machine ls
NAME    ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS
myvm1   -        virtualbox   Running   tcp://192.168.99.100:2376           v17.06.2-ce
myvm2   -        virtualbox   Running   tcp://192.168.99.101:2376           v17.06.2-ce</code></pre>

          <h4>
            <a name="_root-Initalize the swarm and add nodes" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Initalize the swarm and add nodes
          </h4><p>The first machine acts as the manager, which executes management commands and authenticates workers to join the swarm, and the second is a worker.</p>
<p>You can send commands to your VMs using <code>docker-machine ssh</code>. Instruct <code>myvm1</code> to become a swarm manager with <code>docker swarm init</code> and look for output like this:</p>
<pre><code class="language-bash">$ docker-machine ssh myvm1 &quot;docker swarm init --advertise-addr &lt;myvm1 ip&gt;&quot;
Swarm initialized: current node &lt;node ID&gt; is now a manager.

To add a worker to this swarm, run the following command:

  docker swarm join \
  --token &lt;token&gt; \
  &lt;myvm ip&gt;:&lt;port&gt;

To add a manager to this swarm, run &#39;docker swarm join-token manager&#39; and follow the instructions.</code></pre>
<blockquote>

          <h5>
            <a name="_root-Ports 2377 and 2376" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Ports 2377 and 2376
          </h5><p>Always run <code>docker swarm init</code> and <code>docker swarm join</code> with port 2377 (the swarm management port), or no port at all and let it take the default.</p>
<p>The machine IP addresses returned by <code>docker-machine ls</code> include port 2376, which is the Docker daemon port. Do not use this port or <a href="https://forums.docker.com/t/docker-swarm-join-with-virtualbox-connection-error-13-bad-certificate/31392/2">you may experience errors</a>.</p>
</blockquote>
<blockquote>

          <h5>
            <a name="_root-Having trouble using SSH? Try the --native-ssh flag" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Having trouble using SSH? Try the --native-ssh flag
          </h5><p>Docker Machine has <a href="https://docs.docker.com/machine/reference/ssh/#different-types-of-ssh">the option to let you use your own system’s SSH</a>, if for some reason you’re having trouble sending commands to your Swarm manager. Just specify the <code>--native-ssh</code> flag when invoking the <code>ssh</code> command:</p>
<pre><code>docker-machine --native-ssh ssh myvm1 ...</code></pre></blockquote>
<p>As you can see, the response to <code>docker swarm init</code> contains a pre-configured <code>docker swarm join</code> command for you to run on any nodes you want to add. Copy this command, and send it to <code>myvm2</code> via <code>docker-machine ssh</code> to have <code>myvm2</code> join your new swarm as a worker:</p>
<pre><code>$ docker-machine ssh myvm2 &quot;docker swarm join \
--token &lt;token&gt; \
&lt;ip&gt;:2377&quot;

This node joined a swarm as a worker.</code></pre><p>Congratulations, you have created your first swarm!</p>
<p>Run <code>docker node ls</code> on the manager to view the nodes in this swarm:</p>
<pre><code>$ docker-machine ssh myvm1 &quot;docker node ls&quot;
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS
brtu9urxwfd5j0zrmkubhpkbd     myvm2               Ready               Active
rihwohkh3ph38fhillhhb84sk *   myvm1               Ready               Active              Leader</code></pre><blockquote>

          <h5>
            <a name="_root-Leaving a swarm" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Leaving a swarm
          </h5><p>If you want to start over, you can run <code>docker swarm leave</code> from each node.</p>
</blockquote>

          <h3>
            <a name="_root-Deploy your app on the swarm cluster" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Deploy your app on the swarm cluster
          </h3><p><strong>The hard part is over.</strong> Now you just repeat the process you used in <a href="https://docs.docker.com/get-started/part3/">part 3</a> to deploy on your new swarm. </p>
<p><strong>Just remember that only swarm managers like <code>myvm1</code> execute Docker commands; workers are just for capacity.</strong></p>

          <h4>
            <a name="_root-Two ways to talk to your vms" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Two ways to talk to your vms
          </h4><p>So far, you’ve been wrapping Docker commands in <code>docker-machine ssh</code> to talk to the VMs. </p>
<p>Another option is to run <code>docker-machine env &lt;machine&gt;</code> to get and run a command that configures your current shell to talk to the Docker daemon on the VM. This method works better for the next step because it allows you to use your local <code>docker-compose.yml</code> file to deploy the app “remotely” without having to copy it anywhere.</p>
<p>Type <code>docker-machine env myvm1</code>, then copy-paste and run the command provided as the last line of the output to configure your shell to talk to <code>myvm1</code>, the swarm manager.</p>
<p>The commands to configure your shell differ depending on whether you are Mac, Linux, or Windows, so examples of each are shown on the tabs below.</p>
<p>To more details, refer to: <a href="https://docs.docker.com/get-started/part4/#configure-a-docker-machine-shell-to-the-swarm-manager">https://docs.docker.com/get-started/part4/#configure-a-docker-machine-shell-to-the-swarm-manager</a></p>

          <h4>
            <a name="_root-Deploy" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Deploy
          </h4><pre><code class="language-bash"># send compose file to manager node with scp
$ docker-machine scp docker-compose.yml myvm1:~                                             

# deploy it
$ docker-machine ssh myvm1 &quot;docker stack deploy -c docker-compose.yml getstartedlab&quot;  
Creating network getstartedlab_webnet
Creating service getstartedlab_web

# get it&#39;s info
$ docker-machine ssh myvm1 &quot;docker stack ps getstartedlab&quot;
ID                  NAME                  IMAGE                              NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS              
kjeymj6rp0y8        getstartedlab_web.1   johndmulhausen/get-started:part1   myvm2               Running             Running 24 seconds ago                                          
dehkjrmu0fxn        getstartedlab_web.2   johndmulhausen/get-started:part1   myvm1               Running             Running 18 seconds ago                                          
acnejfyy1cmg        getstartedlab_web.3   johndmulhausen/get-started:part1   myvm2               Running             Running 24 seconds ago                                          
36lpsek707gj        getstartedlab_web.4   johndmulhausen/get-started:part1   myvm1               Running             Running 18 seconds ago                                          
q5yb5uj97ef1        getstartedlab_web.5   johndmulhausen/get-started:part1   myvm2               Running             Running 24 seconds ago                                          </code></pre>

          <h3>
            <a name="_root-Accessing your cluster" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Accessing your cluster
          </h3><p>You can access your app from the IP address of <strong>either</strong> <code>myvm1</code> or <code>myvm2</code>.</p>
<p>The network you created is shared between them and load-balancing. Run <code>docker-machine ls</code> to get your VMs’ IP addresses and visit either of them on a browser, hitting refresh (or just <code>curl</code> them).</p>
<p>There are five possible container IDs all cycling by randomly, demonstrating the load-balancing.</p>
<p><strong>The reason both IP addresses work is that nodes in a swarm participate in an ingress routing mesh</strong>. </p>
<p>This ensures that a service deployed at a certain port within your swarm always has that port reserved to itself, no matter what node is actually running the container. Here’s a diagram of how a routing mesh for a service called <code>my-web</code> published at port <code>8080</code> on a three-node swarm would look:</p>
<p><img src="https://docs.docker.com/engine/swarm/images/ingress-routing-mesh.png" alt="ingress-routing-mesh"></p>

          <h3>
            <a name="_root-Enough for now" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Enough for now
          </h3><p>So far you can do a lot of things with docker-machine and knowing how to setup a docker swarm with what you&#39;ve learn.</p>
<p>There are also some options you might have check out such as cleanup/reboot/reset.</p>
<p>Please refer to: <a href="https://docs.docker.com/get-started/part4/#cleanup-and-reboot">https://docs.docker.com/get-started/part4/#cleanup-and-reboot</a></p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>