<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/jump-1.3.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/img/favicon.ico" />
    <link rel="icon" href="/img/favicon.ico" type="image/ico"/>
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">ğŸš€</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">ğŸŒ‘</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="fccefbaf">å‰è¨€</h3><p>2æœˆä»½çš„æ—¶å€™ï¼Œç–«æƒ…åŸå› ï¼Œå­¦æ ¡å®éªŒå®¤å’Œå­¦é™¢è¦å¼€å‘ä¸€æ¬¾å¸®åŠ©å°åŒºå±…æ°‘æ‰¹é‡é‡‡è´­çš„å°ç¨‹åºï¼Œå®éªŒå®¤å›¢é˜Ÿäººæ‰‹ä¸è¶³ï¼Œè¯´æ˜¯å°‘åå°å¼€å‘ï¼Œæ‰€ä»¥æˆ‘å°±ä¸Šäº†ï¼Œçœ‹ç€å¾®ä¿¡çš„æ–‡æ¡£è¿˜æœ‰å­¦é•¿çš„å¸®åŠ©ï¼Œä¹Ÿå°±å­å“§å­å“§å†™ä¸Šçº¿äº†</p>

          <h3 id="4a4b81b">æ“ä½œæµç¨‹</h3><p>
        <div class="_showpic_c3b71faa showpicbtn">Loading images >></div>
        <img href=https://pay.weixin.qq.com/wiki/doc/api/img/wxa-7-2.jpg class="_pic_c3b71faa hidepic" picId="c3b71faa"></img>
        <script>
            {
                let imgselfc3b71faas = document.getElementsByClassName('_pic_c3b71faa')
                let showpicbtnc3b71faas = document.getElementsByClassName('_showpic_c3b71faa')
                let isInViewPortOfTwoc3b71faa = function () {
                    const viewPortHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight 
                    const top = imgselfc3b71faas[0].getBoundingClientRect() && imgselfc3b71faas[0].getBoundingClientRect().top
                    if (top  <= viewPortHeight + 300) {
                        for (el of imgselfc3b71faas) {
                            el.src = el.getAttribute('href')
                            el.classList.add('showpic')
                            window.removeEventListener('scroll', isInViewPortOfTwoc3b71faa)
                            isInViewPortOfTwoc3b71faa = null
                        }
                        for (el of showpicbtnc3b71faas) {
                            el.style.display = 'none'
                        }
                    }
                }
                window.addEventListener('scroll', isInViewPortOfTwoc3b71faa)
            }
        </script>
    </p>
<p style="text-align: center;">å›¾æºï¼š<a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_4&index=3" target="_blank">å¾®ä¿¡æ–‡æ¡£</a></p>

<p>è¿™ä¸ªå›¾å…¶å®è¿‡äºç»†åˆ†ï¼Œæœ‰çš„æ­¥éª¤å¯ä»¥ç®€åŒ–ï¼šopenIdä¸å¿…ç”±<strong>å•†æˆ·åå°</strong>å‘é€è¯·æ±‚æ¥è·å–ï¼Œ<strong>å°ç¨‹åºæ–¹</strong>å¯ä»¥ç›´æ¥å‘é€openIdè¿‡æ¥ã€‚</p>
<ol>
<li><strong>ç”¨æˆ·</strong>é€šè¿‡<strong>å°ç¨‹åº</strong>å‘é€<strong>â€œè¯·æ±‚ä¸‹å•â€</strong>çš„è¯·æ±‚åˆ°<strong>å•†æˆ·åå°</strong>ï¼›</li>
<li><strong>å•†æˆ·åå°</strong>è°ƒç”¨å¾®ä¿¡å®˜æ–¹ä¾èµ–æä¾›çš„æ¥å£ï¼Œå‘é€è¯·æ±‚åˆ°<strong>å¾®ä¿¡åå°</strong>ï¼ˆç»Ÿä¸€ä¸‹å•APIï¼‰ï¼Œè·å–<code>prepay_id</code>ï¼›</li>
<li><strong>å•†æˆ·åå°</strong>ç”Ÿæˆç­¾åï¼Œè¿”å›5ä¸ªå‚æ•°å’Œsignï¼›</li>
<li><strong>å°ç¨‹åº</strong>è·å–åˆ°æ­£å¸¸çš„5ä¸ªå‚æ•°å’Œsignä¹‹åï¼Œè°ƒç”¨JSçš„SDKä¸­çš„æ”¯ä»˜APIï¼Œ<strong>ç”¨æˆ·</strong>ç•Œé¢æ‹‰èµ·æ”¯ä»˜ï¼Œæ”¯ä»˜æˆåŠŸï¼›</li>
</ol>
<p>è¿™ä¸ªå›¾å±•ç¤ºçš„éƒ¨åˆ†å°±è¿™ä¹ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ“ä½œåç»­çš„ä¸šåŠ¡ï¼Œå°±æ˜¯ç”¨æˆ·åœ¨<strong>å°ç¨‹åº</strong>æ”¯ä»˜ä¹‹åï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚æŠŠæ”¯ä»˜ç»“æœå‘Šè¯‰åˆ°<strong>å•†æˆ·åå°</strong>ï¼Œè¿™æ ·<strong>å•†æˆ·åå°</strong>æ‰èƒ½å¤Ÿå³ä½¿å›å†™è¿™ä¸ªè®¢å•çš„æ”¯ä»˜çŠ¶æ€åˆ°å•†æˆ·è‡ªå·±çš„æ•°æ®åº“ä¸­ï¼Œè™½ç„¶<strong>å¾®ä¿¡åå°</strong>ä¼šæ¨é€æ”¯ä»˜ç»“æœç»™<strong>å•†æˆ·åå°</strong>ï¼Œä½†æ˜¯å¾®ä¿¡<a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_7">ä¸ä¿è¯åŠæ—¶æ€§ä»¥åŠè¯·æ±‚å¿…è¾¾</a>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é è‡ªå·±å¼ºåˆ¶å›å†™ã€‚</p>
<ol start="5">
<li>æ”¯ä»˜æˆåŠŸ/å¤±è´¥åï¼Œ<strong>å°ç¨‹åº</strong>éƒ½éœ€è¦å¼ºåˆ¶å‘é€æ”¯ä»˜ç»“æœåˆ°<strong>å•†æˆ·åå°</strong>ï¼›</li>
<li><strong>å•†æˆ·åå°</strong>å¤„ç†æ”¯ä»˜ç»“æœï¼Œå›å†™åˆ°æ•°æ®åº“ï¼›</li>
</ol>

          <h3 id="d78e444e">åç«¯</h3><p>åç«¯é¡¹ç›®å‚è€ƒï¼š</p>

          <h4 id="98b76268">å‰ç½®å‚è€ƒ</h4><ul>
<li><a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1">è¯·æ±‚å‚æ•°å‚è€ƒ</a></li>
<li><a href="https://github.com/Wechat-Group/WxJava/wiki/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98">ä»£ç å‚è€ƒ</a></li>
<li><a href="https://github.com/binarywang/weixin-java-pay-demo/blob/5ea0ad02efb734751dce18eee35817af82c3ee13/src/main/java/com/github/binarywang/demo/wx/pay/controller/WxPayController.java#L106">å®˜æ–¹Demo</a></li>
<li><a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&amp;index=5">ç­¾åæ–¹å¼</a></li>
</ul>

          <h4 id="ba497bca">è‡ªå·±çš„å®ç°</h4>
          <h5 id="66c8b3c9">è·å–5ä¸ªå‚æ•°å’Œsign</h5><p>ä¸‹é¢è¿™ä¸ªæ¥å£å®Œæˆäº†æµç¨‹çš„2å’Œ3ï¼š</p>
<pre><code class="language-java">@PostMapping(&quot;/unifiedOrder&quot;)
@ResponseBody
public Object unifiedOrder(@RequestBody WxPayUnifiedOrderRequest request, HttpServletRequest realReq) {
    request.setAppid(WeChatConfigParam.WX_LOGIN_APPID);
    request.setMchId(WeChatConfigParam.WX_PAY_MCHID);
    request.setBody(WeChatConfigParam.WX_PAY_BODY);
    request.setTradeType(WeChatConfigParam.WX_PAY_TRADE_TYPE);
    request.setNotifyUrl(WeChatConfigParam.WX_PAY_NOTIFY_URL);
    request.setSpbillCreateIp(IpUtil.getIpAddr(realReq));

    Map&lt;String, String&gt; result = new HashMap&lt;&gt;(8);
    // è·å– prepay_id
    WxPayUnifiedOrderResult wxPayUnifiedOrderResult = null;
    try {
        wxPayUnifiedOrderResult = this.wxService.unifiedOr1zzder(request);
        result.put(&quot;returnCode&quot;, wxPayUnifiedOrderResult.getReturnCode());
        result.put(&quot;returnMsg&quot;, wxPayUnifiedOrderResult.getReturnMsg());
        if (wxPayUnifiedOrderResult.getReturnCode().equalsIgnoreCase(WeChatConfigParam.WX_PAY_SUCCESS_FLAG) &amp;&amp;
                wxPayUnifiedOrderResult.getResultCode().equalsIgnoreCase(WeChatConfigParam.WX_PAY_SUCCESS_FLAG)) {
            // åˆ©ç”¨prepay_id ç­¾MD5
            String key = WeChatConfigParam.WX_PAY_MCHKEY;
            String appId = WeChatConfigParam.WX_LOGIN_APPID;
            long timeStamp = System.currentTimeMillis() / 1000;
            String nonceStr = DigestUtils.md5Hex(UUID.randomUUID().toString());
            String packageStr = &quot;prepay_id=&quot; + wxPayUnifiedOrderResult.getPrepayId();
            String sign = DigestUtils.md5Hex(&quot;appId=&quot; + appId + &quot;&amp;nonceStr=&quot; + nonceStr + &quot;&amp;package=&quot; + packageStr + &quot;&amp;signType=MD5&amp;timeStamp=&quot; + timeStamp + &quot;&amp;key=&quot; + key);
            result.put(&quot;appId&quot;, appId);
            result.put(&quot;timeStamp&quot;, timeStamp + &quot;&quot;);
            result.put(&quot;nonceStr&quot;, nonceStr);
            result.put(&quot;package&quot;, packageStr);
            result.put(&quot;signType&quot;, &quot;MD5&quot;);
            result.put(&quot;paySign&quot;, sign);
        }
        result.put(&quot;resultCode&quot;, wxPayUnifiedOrderResult.getResultCode());
    } catch (WxPayException e) {
        result.put(&quot;returnCode&quot;, e.getReturnCode());
        result.put(&quot;returnMsg&quot;, e.getReturnMsg());
        result.put(&quot;resultCode&quot;, e.getResultCode());
        result.put(&quot;errCode&quot;, e.getErrCode());
        result.put(&quot;errCodeDes&quot;, e.getErrCodeDes());
    }

    // ç›´æ¥è¿”å›resultç»™å‰ç«¯ å‰ç«¯æ ¹æ®resultç›´æ¥è°ƒèµ·æ”¯ä»˜API
    return result;
}</code></pre>
<p>è¿™é‡Œéœ€è¦å’Œå‰ç«¯çº¦å®šå¥½ï¼Œå‰ç«¯å‘é€è¯·æ±‚çš„æ—¶å€™åªéœ€è¦å¸¦ä¸Š3ä¸ªå‚æ•°ï¼š</p>
<pre><code class="language-json">{
    â€œoutTradeNoâ€: &quot;xxxxx&quot;,
    &quot;openId&quot;: &quot;xxxxx&quot;,
    &quot;totalFee&quot;: 1000
}</code></pre>

          <h5 id="f788cffd">ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜ç»“æœå¹¶å›å†™</h5><pre><code class="language-java">@GetMapping(&quot;/checkOrderPaymentState&quot;)
@ResponseBody
public Object queryOrder(@RequestParam(required = false) String transactionId, @RequestParam String outTradeNo) {
    Map&lt;String, String&gt; result = new HashMap&lt;&gt;(8);
    try {
        WxPayOrderQueryResult wxPayOrderQueryResult = this.wxService.queryOrder(transactionId, outTradeNo);
        Oder od = orderService.getOrderByOId(Integer.parseInt(outTradeNo));

        // ä»…åœ¨è¯¥æƒ…å†µä¸‹ä¸»åŠ¨æ›´æ–°æ•°æ®åº“çš„æ”¯ä»˜çŠ¶æ€
        // 1. è¯¥è®¢å•åœ¨æ•°æ®åº“å­˜åœ¨ï¼› 2. è¯¥è®¢å•çš„æ”¯ä»˜çŠ¶æ€åœ¨æ•°æ®åº“ä¸ºæœªæ”¯ä»˜ï¼› 3. è¯¥è®¢å•çš„æ”¯ä»˜çŠ¶æ€åœ¨å¾®ä¿¡æ•°æ®åº“ä¸ºå·²æ”¯ä»˜
        if (od != null
                &amp;&amp; od.getPaymentStatus() == 0
                &amp;&amp; wxPayOrderQueryResult.getTradeState().equalsIgnoreCase(WeChatConfigParam.WX_PAY_SUCCESS_FLAG)) {
            if (orderService.updateOrderPaymentStatusByOid(od.getOid()) == 1) {
                result.put(&quot;resultMsg&quot;, &quot;UPDATE_SUCCESS&quot;);
            } else {
                result.put(&quot;resultMsg&quot;, &quot;UPDATE_FAIL&quot;);
            }
        } else {
            result.put(&quot;resultMsg&quot;, &quot;UNABLE_TO_UPDATE&quot;);
        }
    } catch (WxPayException e) {
        log.warn(&quot;No such pay order with oid:&quot; + outTradeNo);
        result.put(&quot;resultMsg&quot;, &quot;NO_SUCH_PAYMENT_ORDER_IN_WECHAT&quot;);
        return result;
    }
    return result;
}</code></pre>

          <h5 id="152959ea">æä¾›ç»™å¾®ä¿¡åå°çš„notifyæ¥å£</h5><pre><code class="language-java">@PostMapping(&quot;/notify/order&quot;)
public String parseOrderNotifyResult(@RequestBody String xmlData) throws WxPayException {
    final WxPayOrderNotifyResult notifyResult = this.wxService.parseOrderNotifyResult(xmlData);
    String outTradeNo = notifyResult.getOutTradeNo();
    Oder od = orderService.getOrderByOId(Integer.parseInt(outTradeNo));
    // ä»æ•°æ®åº“è·å–è¯¥è®¢å•çš„æ€»é‡‘é¢ å•ä½ä¸º â€˜å…ƒâ€™ ä¹˜ä»¥100è½¬ä¸º â€˜åˆ†â€™
    Float totalPrice = od.getTotalPrice() * 100;
    // å¾®ä¿¡åå°é€šçŸ¥çš„æ”¯ä»˜ç»“æœä¸­çš„äº¤æ˜“é‡‘é¢ å•ä½ä¸º â€˜åˆ†â€™
    Float totalFee = Float.valueOf(notifyResult.getTotalFee());
    if (totalFee.equals(totalPrice)) {
        int updateCount  = orderService.updateOrderPaymentStatusByOid(od.getOid());
        if (updateCount != 1){
            return WxPayNotifyResponse.success(WeChatConfigParam.WX_PAY_FAIL_FLAG);
        }
        return WxPayNotifyResponse.success(WeChatConfigParam.WX_PAY_SUCCESS_FLAG);
    } else {
        return WxPayNotifyResponse.success(WeChatConfigParam.WX_PAY_FAIL_FLAG);
    }
}</code></pre>

          <h3 id="6594a8b5">åè¯</h3><p>éœ€æ±‚ç®€å•ï¼Œæ‰€ä»¥åªç”¨åˆ°äº†è¯·æ±‚æ”¯ä»˜ä¸‹å•ä»¥åŠæŸ¥è¯¢æ”¯ä»˜ç»“æœè¿™ä¸¤ä¸ªæ¥å£ï¼Œé€€æ¬¾çš„æ¥å£ä»€ä¹ˆçš„éƒ½æ²¡å†™ï¼Œç”¨äº†å¤§æ¦‚1å¤©çš„æ—¶é—´è°ƒé€šï¼Œ3å¤©çš„æ—¶é—´å®Œå–„ä¸Šçº¿</p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>