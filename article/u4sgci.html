<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/jump-1.3.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/img/favicon.ico" />
    <link rel="icon" href="/img/favicon.ico" type="image/ico"/>
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">ğŸš€</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">ğŸŒ‘</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="e25a21eb">Introduction</h3><p>ä¸ŠèŠ‚æˆ‘ä»¬ä»‹ç»äº†Javaå¹¶å‘ç¼–ç¨‹çš„ä¸€ä¸ªæ–°çš„é˜¶æ®µâ€”â€”Javaå¹¶å‘åŒ…ä¸­çš„<code>Lock</code>æ¥å£ä»¥åŠ<code>AbstractQueuedSynchronizer</code>çš„é…åˆä½¿ç”¨</p>
<p>å¹¶ä¸”å°è¯•å®ç°äº†ä¸€ä¸ªç®€å•çš„ç‹¬å é”Mutexï¼Œå€Ÿæ­¤æˆ‘ä»¬äº†è§£åˆ°ï¼Œå¹¶å‘ç¼–ç¨‹è¿˜èƒ½å¦‚æ­¤çµæ´»ä¸ä¼˜é›…</p>
<p>æœ¬èŠ‚è¿˜æ˜¯å±äºç¬¬ä¸ƒåï¼Œå› ä¸ºç¬¬ä¸ƒååº”è¯¥æ˜¯å…³äºæ•´ä¸ªJavaå¹¶å‘åŒ…çš„åŸºç¡€å†…å®¹ï¼Œæ‰€ä»¥ä¼šåˆ†æˆå¤šèŠ‚è¿›è¡Œ</p>
<p>åœ¨ä¸ŠèŠ‚çš„æœ€åæˆ‘ä»¬è¿ç”¨<code>Lock</code>å’Œ<code>AbstractQueuedSynchronizer</code>å»ç®€å•åœ°å®ç°äº†ä¸€ä¸ªç‹¬å é”ï¼Œæœ¬èŠ‚æˆ‘ä»¬ç´§æ¥ç€è¦åˆ†æä¸€ä¸‹<code>AbstractQueuedSynchronizer</code>çš„éƒ¨åˆ†æ–¹æ³•çš„å®ç°åŸç†ï¼Œäº†è§£åŒæ­¥å™¨ä¸ºä»€ä¹ˆèƒ½å¦‚æ­¤å¼ºå¤§</p>
<p>æœ¬ç¯‡å‚è€ƒä¹¦æœ¬ä¸Šï¼Œè¯•å›¾åˆ†æ<strong>ç‹¬å å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾/å…±äº«å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾</strong>çš„æºç </p>
<p>è§‚å¯Ÿæºç ä¹‹å‰æˆ‘ä»¬éœ€è¦å›é¡¾ä¸€ä¸‹ï¼š</p>
<blockquote>
<p> å¯¹äºåŒæ­¥å™¨ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å®ç°çš„æ˜¯ï¼š<strong>å¯¹åŒæ­¥çŠ¶æ€çš„â€œå°è¯•â€è·å–/é‡Šæ”¾</strong>çš„ä¸€ç±»æ–¹æ³•</p>
<ul>
<li>tryæ–¹æ³•åªè¿”å›æ˜¯å¦è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼ˆç‹¬å å¼ï¼‰/è·å–åˆ°äº†1ä¸ªä»¥ä¸Šçš„åŒæ­¥çŠ¶æ€ï¼ˆå…±äº«å¼ï¼‰</li>
<li>è¿™ç±»æ–¹æ³•è¢«æ¨¡æ¿æ–¹æ³•ç¬¬ä¸€æ¬¡å°è¯•è°ƒç”¨ï¼š<ul>
<li>è‹¥æˆåŠŸï¼Œåˆ™çº¿ç¨‹è·å–åˆ°é”ï¼›</li>
<li>è‹¥å¤±è´¥ï¼Œåˆ™æ¨¡æ¿æ–¹æ³•ç»§ç»­ç®¡ç†åŒæ­¥é˜Ÿåˆ—</li>
</ul>
</li>
<li>åœ¨çº¿ç¨‹æˆä¸ºç»“ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­ï¼Œç»“ç‚¹åœ¨è‡ªæ—‹çš„æ—¶å€™ä¹Ÿåœ¨ä¸æ–­åœ°tryè·å–åŒæ­¥çŠ¶æ€</li>
</ul>
</blockquote>

          <h3 id="cb8c7193">SynchronizedQueue</h3><p>åŒæ­¥å™¨ä¾èµ–å†…éƒ¨å®ç°çš„ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—æ¥å®Œæˆ<strong>åŒæ­¥çŠ¶æ€çš„ç®¡ç†</strong>ï¼Œå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„æ—¶å€™ï¼ŒåŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œ<strong>åŒæ—¶é˜»å¡å½“å‰çº¿ç¨‹</strong></p>
<p>åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç»“ç‚¹ç”¨æ¥ä¿å­˜åŒæ­¥çŠ¶æ€è·å–å¤±è´¥çš„çº¿ç¨‹å¼•ç”¨ã€ç­‰å¾…çŠ¶æ€ä»¥åŠå‰é©±å’Œåç»§ç»“ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Nodeç»“æ„ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒNodeçš„ç»“æ„æ˜¯CLHé˜Ÿåˆ—é”çš„ä¸€ä¸ªå˜ä½“ï¼ŒCLHé˜Ÿåˆ—é”æ˜¯ä¸€ç§è‡ªæ—‹é”ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒ<a href="https://youyinnn.github.io/?to=post&amp;number=92">è¿™é‡Œ</a>æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œæ¨èå­¦ä¹ Nodeä¹‹å‰çœ‹ä¸€ä¸‹CLHé˜Ÿåˆ—é”</p>
<pre><code class="language-java">static final class Node {
    /** Marker to indicate a node is waiting in shared mode */
    static final Node SHARED = new Node();
    /** Marker to indicate a node is waiting in exclusive mode */
    static final Node EXCLUSIVE = null;

    // åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„çº¿ç¨‹å¦‚æœè¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†ï¼Œåˆ™ä¼šè½¬å˜ä¸ºæ­¤çŠ¶æ€ï¼Œä¸”ä»¥åä¸ä¼šå†å‘ç”ŸçŠ¶æ€å˜åŒ–
    static final int CANCELLED =  1;
    // åç»§ç»“ç‚¹å¦‚æœå¤„äºç­‰å¾…ï¼ˆparkï¼‰çŠ¶æ€ï¼Œè€Œå½“å‰ç»“ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆäº†çš„è¯ï¼Œå°±ä¼šå”¤é†’(unpark)åç»§ç»“ç‚¹
    static final int SIGNAL    = -1;
    // ç»“ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç»“ç‚¹ç­‰å¸¦åœ¨Conditionä¸Šï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†Conditionçš„signal()æ–¹æ³•ï¼Œåˆ™è¯¥ç»“ç‚¹ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°åŒæ­¥çŠ¶æ€çš„è·å–ä¸­
    static final int CONDITION = -2;
    // è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€çš„è·å–ä¼šè¢«æ— æ¡ä»¶åœ°ä¼ æ’­ä¸‹å»
    static final int PROPAGATE = -3;
    volatile int waitStatus;

    // å‰é©±èŠ‚ç‚¹
    volatile Node prev;
    // åç»§ç»“ç‚¹
    volatile Node next;
    // è¦è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹
    volatile Thread thread;
    // ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»§ç»“ç‚¹
    Node nextWaiter;

    final boolean isShared() {
        return nextWaiter == SHARED;
    }
    final Node predecessor() throws NullPointerException {
        Node p = prev;
        if (p == null)
            throw new NullPointerException();
        else
            return p;
    }
    Node() {    // Used to establish initial head or SHARED marker
    }
    Node(Thread thread, Node mode) {     // Used by addWaiter
        this.nextWaiter = mode;
        this.thread = thread;
    }
    Node(Thread thread, int waitStatus) { // Used by Condition
        this.waitStatus = waitStatus;
        this.thread = thread;
    }
}</code></pre>
<p>ç»“ç‚¹æ˜¯æ„æˆ<strong>åŒæ­¥é˜Ÿåˆ—</strong>å’Œ<strong>ç­‰å¾…é˜Ÿåˆ—</strong>çš„åŸºç¡€ï¼Œç­‰å¾…é˜Ÿåˆ—çš„æ¦‚å¿µä¼šåœ¨åé¢å‡ èŠ‚ä»‹ç»ï¼Œå®ƒå’ŒConditionå¯¹è±¡æœ‰å…³ï¼›</p>
<p>æˆ‘ä»¬çœ‹åˆ°æœ€å‰é¢ä¸¤ä¸ªå˜é‡éƒ½æ˜¯Nodeç±»å‹çš„ï¼Œåˆ†åˆ«ä»£è¡¨ç»“ç‚¹çš„å…±äº«å¼å’Œç‹¬å å¼ä¸¤ç§æ¨¡å¼ï¼Œç„¶åå°±æ˜¯ç»“ç‚¹çš„çŠ¶æ€ä»¥åŠå‰é©±åç»§ç»“ç‚¹çš„å¼•ç”¨ï¼Œå…³äº<code>nextWaiter</code>çš„æ„ä¹‰æˆ‘ä»¬åé¢è¯´åˆ°ç­‰å¾…é˜Ÿåˆ—çš„æ—¶å€™å†ç»†è¯´</p>
<p>åŒæ­¥å™¨æ‹¥æœ‰å¤´èŠ‚ç‚¹headå’Œå°¾ç»“ç‚¹tailï¼Œæ²¡æœ‰æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ä¼šç§°ä¸ºç»“ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå…¶ç»“æ„å¤§æ¦‚æ˜¯ï¼š</p>
<pre class="nhi">
         AQS        setHead(Node update)
    -------------    /
    |           |   /     Node         Node         Node         Node
    |  { head }-|------&gt;{ prev }&lt;----{-prev }&lt;----{-prev }&lt;----{-prev }
    |           |       { next-}----&gt;{ next-}----&gt;{ next-}----&gt;{ next }
    |  { tail }-|-------------------------------------------------^
    |           |        \
    -------------      compareAndSetTail(Node expect, Node update)
</pre>


<p>æŠŠ<strong>å½“å‰ç»“ç‚¹ï¼ˆåˆšè·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹æ„æˆçš„ç»“ç‚¹ï¼‰</strong>åˆ°å°¾éƒ¨çš„è¿‡ç¨‹å¿…é¡»ç”¨CASçš„æ–¹å¼å»åšï¼Œ<strong>ä¿è¯æ¯ä¸ªå¹¶å‘åŠ å…¥çš„ç»“ç‚¹æœ€ç»ˆèƒ½å¤Ÿä¸²è¡Œæˆé˜Ÿåˆ—</strong>ï¼Œå®ƒéœ€è¦ä¼ å…¥å½“å‰çº¿ç¨‹â€œè®¤ä¸ºâ€çš„å°¾ç»“ç‚¹å’Œå½“å‰ç»“ç‚¹</p>
<p>åŒæ­¥é˜Ÿåˆ—ä¹Ÿéµä»FIFOï¼Œé¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„ç»“ç‚¹ï¼Œé¦–èŠ‚ç‚¹çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼Œä¼šå”¤é†’åç»§ç»“ç‚¹ï¼Œè€Œåç»§ç»“ç‚¹ä¼šåœ¨<strong>è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„é‚£ä¸€åˆ»</strong>å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ï¼Œå› ä¸ºè®¾ç½®é¦–èŠ‚ç‚¹çš„å‰ææ˜¯<strong>è·å–åˆ°åŒæ­¥çŠ¶æ€</strong>ï¼Œ<u>ç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€</u>ï¼Œæ‰€ä»¥è®¾ç½®é¦–èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯ï¼Œå®ƒåªéœ€è¦å°†é¦–èŠ‚ç‚¹è®¾ç½®æˆåŸé¦–èŠ‚ç‚¹çš„åç»§ï¼Œå¹¶ä¸”æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯</p>
<blockquote>
<p>è¿™é‡Œå°±æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœæ˜¯å…±äº«å¼é”çš„æƒ…å†µä¸‹ï¼ŒåŒæ­¥çŠ¶æ€å›è¢«å¤šä¸ªçº¿ç¨‹è·å–åˆ°ï¼Œé‚£åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ç–‘é—®è§£å†³ï¼šçœ‹å®Œåé¢çš„sharedèŠ‚ç‚¹çš„è·å–è¿‡ç¨‹ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“ï¼Œåœ¨åŒæ­¥çŠ¶æ€è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œunparkæ˜¯ä¼šä¼ é€’ä¸‹å»çš„</p>
</blockquote>

          <h4 id="529ecebe">Exclusive acquire &amp; release</h4>
          <h5 id="6d13c799">acquire</h5><p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„<code>acquire(int arg)</code>æ–¹æ³•å¯ä»¥è·å–åˆ°åŒæ­¥çŠ¶æ€</p>
<pre><code class="language-java">public final void acquire(int arg) {
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}</code></pre>
<p>åœ¨è·å–åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼Œé¦–å…ˆè°ƒç”¨<code>tryAcquire(int arg)</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æˆ‘ä»¬éœ€è¦å®ç°çš„æ¨¡æ¿æ–¹æ³•ä¹‹ä¸€ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯è¯¥æ–¹æ³•èƒ½å¤Ÿçº¿ç¨‹å®‰å…¨åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œæ–¹æ³•å°è¯•è·å–ä¸€æ¬¡åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™<code>acquire(int arg)</code>æ–¹æ³•ç»“æŸï¼›å¦‚æœè·å–å¤±è´¥ï¼Œé¦–å…ˆè°ƒç”¨<code>addWaiter</code>æ–¹æ³•å°†è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹æ„å»ºä¸ºNodeç»“ç‚¹ï¼ˆNode.EXCLUSIVEï¼‰ï¼Œç„¶ååŠ å…¥åˆ°é˜Ÿå°¾ï¼Œæœ€åè°ƒç”¨<code>acquireQueued</code>æ–¹æ³•ï¼Œè®©è¿™ä¸ªç»“ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼ä¸æ–­è·å–åŒæ­¥çŠ¶æ€<strong>ï¼ˆå®é™…ä¸Šä¹Ÿå°±å¾ªç¯äº†2æ¬¡ï¼Œä¹‹åå°±ä¼šè¢«parkæ‰ï¼‰</strong>ï¼Œè‹¥æ˜¯è·å–å¤±è´¥ï¼Œåˆ™é˜»å¡ç»“ç‚¹æŒæœ‰çš„çº¿ç¨‹ï¼Œç­‰åˆ°ç»“ç‚¹è¢«å‰é©±ç»“ç‚¹å”¤é†’çš„æ—¶å€™ï¼ˆä¸€èˆ¬æ˜¯å‰é©±ç»“ç‚¹å·²ç»è·å–åˆ°åŒæ­¥çŠ¶æ€å¹¶ä¸”æ‰“ç®—é‡Šæ”¾äº†çš„æ—¶å€™ï¼‰ï¼Œæˆ–è€…é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­äº†çš„æ—¶å€™</p>

          <h5 id="d882867c">addWaiter</h5><pre><code class="language-java">private Node addWaiter(Node mode) {
    Node node = new Node(Thread.currentThread(), mode);
    // Try the fast path of enq; backup to full enq on failure
    Node pred = tail;
    if (pred != null) {
        node.prev = pred;
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    enq(node);
    return node;
}</code></pre>
<p>å¦‚æ³¨é‡Šæ‰€è¯´ï¼ŒNode.EXCLUSIVEæ˜¯ç‹¬å å¼ç»“ç‚¹ï¼ŒNode.SHAREDæ˜¯å…±äº«å¼ç»“ç‚¹ï¼Œæˆ‘å…¶å®å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆè¦ç”¨Nodeå¯¹è±¡æ¥è¡¨ç¤ºç»“ç‚¹çš„modeï¼Œä¹Ÿè®¸åœ¨åé¢çš„å…±äº«å¼ç»“ç‚¹ä¸­æœ‰ä»€ä¹ˆå‡ºå½©çš„æ“ä½œå§ï¼Œåé¢å†ç»§ç»­ç ”ç©¶è¿™ä¸ªäº‹</p>
<p>æ³¨é‡Šé‡Œä¹Ÿè¯´äº†ï¼Œlineï¼š10-17è¡Œåªæ˜¯ä¸€ä¸ª<code>enq</code>çš„å¿«é€Ÿç‰ˆæœ¬ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè¦addWaiterçš„ç»“ç‚¹ï¼Œè¿™æ—¶å€™AQSé‡Œé¢çš„tailæ˜¯ä¸ºnullçš„ï¼›å¦‚æœAQSé‡Œå·²ç»æœ‰tailäº†ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿™æ®µä»£ç ä¸­å°è¯•å¿«é€Ÿè®¾ç½®tailï¼ˆå¦‚æ³¨é‡Šä¸­æ‰€è¯´ï¼‰</p>

          <h5 id="f62b293">enq</h5><pre><code class="language-java">private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}</code></pre>
<p>è¿™partå…¶å®æ˜¯å¾ˆæ¬¢ä¹çš„ï¼Œæ­»å¾ªç¯é‡Œçš„é€»è¾‘ï¼šå¦‚æœtailä¸ºnullï¼Œè¯æ˜è¿™æ˜¯ç¬¬ä¸€ä¸ªè·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹çš„ç»“ç‚¹ï¼Œæ‰€ä»¥call<code>compareAndSetHead</code>ï¼Œåˆšå¼€å§‹è‚¯å®šæ˜¯èµ°çš„è¿™é‡Œï¼Œå°†ä¸€ä¸ªæ–°çš„ç»“ç‚¹è®¾ç½®ä¸ºAQSçš„head</p>
<blockquote>
<p>è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨<code>sun.misc.Unsafe</code>ç±»çš„<code>compareAndSwapObject</code>æ–¹æ³•ï¼Œæ›´åº•å±‚çš„å°±æ²¡å¿…è¦æ·±å…¥äº†ï¼Œä½œç”¨æ˜¯ä»¥CASçš„æ–¹å¼è®¾ç½®AQSçš„headå­—æ®µï¼ŒåŒç†<code>compareAndSetTail</code>ä¹Ÿä¸€æ ·</p>
<p><code>compareAndSwapXXX</code>ç³»åˆ—çš„æ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„å‚æ•°åˆ—è¡¨ï¼Œæ¯”å¦‚SwapIntå°±æ˜¯<code>(Object o, long offset, int expected, int update)</code>ï¼ŒObject oå°±æ˜¯è¦è®¾ç½®å­—æ®µçš„å¯¹è±¡ï¼Œoffsetå€¼åŒæ ·å¯ä»¥é€šè¿‡<code>Unsafe</code>ç±»çš„<code>objectFieldOffset</code>æ–¹æ³•è·å–ï¼Œæ¯”å¦‚åœ¨AQSä¸­å°±æ˜¯ï¼š</p>
<pre><code class="language-java">private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long headOffset;
// ...
static {
    try {
        headOffset = unsafe.objectFieldOffset
            (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;head&quot;));
        // ...
    } catch (Exception ex) { throw new Error(ex); }
}</code></pre>
<p>ç„¶å<code>compareAndSetHead</code>æ–¹æ³•é‡Œé¢ï¼š</p>
<pre><code class="language-java">private final boolean compareAndSetHead(Node update) {
    return unsafe.compareAndSwapObject(this, headOffset, null, update);
}</code></pre>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œunsafeå¯¹è±¡å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåªæœ‰æœ‰é™çš„å‡ ä¸ªç±»åŠ è½½å™¨æ‰èƒ½å¤Ÿè·å–å®ƒçš„å•ä¾‹</p>
</blockquote>
<p>anywayï¼Œåœ¨è®¾ç½®å¥½headäº†ä¹‹åï¼ŒåˆæŠŠtailè®¾ç½®ä¸ºheadï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ—¶å€™tailå’Œheadéƒ½æ˜¯è¿™ä¸ª<code>new Node()</code>ï¼Œè¿™è¿˜æ²¡ç»“æŸï¼Œè¿˜å¾—å†å¾ªç¯ä¸€éï¼Œè¿™ä¸€éæ¥ï¼Œå°±æ˜¯èµ°elseçš„æ—¶å€™äº†ï¼Œè¿˜è®°å¾—ä»<code>enq</code>è¿›æ¥çš„nodeå˜›ï¼Ÿè¿™é‡Œç”¨åˆ°äº†ï¼æˆ‘ä»¬ç§°å®ƒä¸ºå…¥é˜Ÿç»“ç‚¹</p>
<pre><code class="language-java">// ...
// t = tail
else {
    node.prev = t;
    if (compareAndSetTail(t, node)) {
        t.next = node;
        return t;
    }
}</code></pre>
<p>ä¹‹å‰çš„<code>new Node()</code>ä½œä¸ºå…¥é˜Ÿç»“ç‚¹çš„å‰é©±ï¼ˆprevï¼‰ï¼Œç„¶å<code>compareAndSetTail</code>ï¼Œå°†å…¥é˜Ÿç»“ç‚¹è®¾ç½®ä¸ºAQSçš„tailå­—æ®µï¼Œç„¶åtçš„åç»§æŒ‡å‘å…¥é˜Ÿç»“ç‚¹ï¼Œç„¶åè¿”å›tï¼Œè¿™æ—¶å€™AQSçš„ç»“æ„å¦‚ï¼š</p>
<pre class="nhi">
         AQS       
    -------------   
    |           |      new Node()     å…¥é˜Ÿç»“ç‚¹
    |  { head }-|------>{ prev }&lt;----{-prev }
    |           |       { next-}----&gt;{ next }
    |  { tail }-|------------------------^
    |           |        
    ------------- 
</pre>

<p>è¿™æ—¶å€™çš„<code>new Node()</code>æ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ï¼Œç„¶åå…¥é˜Ÿç»“ç‚¹è¿˜ç³»ç€è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹ï¼Œåé¢å¦‚æœå†æœ‰å…¥é˜Ÿçš„ç»“ç‚¹çš„è¯ï¼Œå°±ç›´æ¥èµ°elseï¼Œå°è¯•ä¸æ–­åœ°å°†æ–°å…¥é˜Ÿç»“ç‚¹è®¾ç½®ä¸ºtailï¼Œç›´åˆ°æˆåŠŸçš„æ—¶å€™æ‰è¿”å›ï¼Œè™½ç„¶<code>enq</code>çš„è¿”å›å€¼æ²¡æœ‰è¢«ç”¨åˆ°</p>

          <h5 id="4d67a9ec">aquireQueued</h5><p>ç»“ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œå°±è¿›å…¥äº†ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹å¹¶é˜»å¡ç»“ç‚¹æŒæœ‰çš„çº¿ç¨‹ï¼Œæ¯ä¸ªç»“ç‚¹ä¼šè‡ªæˆ‘å®¡æŸ¥ï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼Œå°±ä¼šä»è‡ªæ—‹ä¸­é€€å‡º</p>
<pre><code class="language-java">final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}</code></pre>
<p>æ¥ä¸Šé¢çš„å†…å®¹ï¼Œå½“æˆ‘ä»¬ä»<code>addWaiter</code>çš„<code>enq</code>æ–¹æ³•è¿”å›ä¹‹åï¼Œ<code>addWaiter</code>ä¹Ÿå°±ç»“æŸäº†ï¼Œè¿”å›å…¥é˜Ÿç»“ç‚¹ï¼Œç„¶åå…¥é˜Ÿç»“ç‚¹è¿›å…¥åˆ°<code>aquireQueued</code>æ–¹æ³•ï¼Œå…¶ä¸­é€šè¿‡æ­»å¾ªç¯æ¥è‡ªå®¡ï¼š</p>
<ul>
<li><p>è·å–<strong>å½“å‰å…¥é˜Ÿç»“ç‚¹</strong>çš„å‰é©±ï¼Œå¦‚æœå‰é©±æ˜¯headçš„è¯ï¼Œé‚£ä¹ˆ<strong>å½“å‰å…¥é˜Ÿç»“ç‚¹</strong>å°±ä¸æ–­åœ°å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ˆline:15 <code>tryAcquire</code>ï¼‰</p>
<ul>
<li><p>å¦‚æœå°è¯•æˆåŠŸï¼Œåˆ™å°†<strong>å½“å‰å…¥é˜Ÿç»“ç‚¹</strong>è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ–­å¼€å¼•ç”¨ä¾¿äºGC</p>
<blockquote>
<p>è¿™é‡Œä¹ŸæŒ‡æ˜äº†ï¼Œå¤´èŠ‚ç‚¹åœ¨ä¸åŒçš„æ—¶å€™å…·æœ‰ä¸åŒçš„æ¶µä¹‰ï¼šå¤´èŠ‚ç‚¹æœ€å¼€å§‹æˆ–è®¸æ˜¯ä¸€ä¸ªæ— ç”¨çš„<code>new Node()</code>ï¼Œä½†æ˜¯å½“ä¸‹ä¸€ä¸ªå…¥é˜Ÿç»“ç‚¹æˆè·å–åŒæ­¥çŠ¶æ€äº†ä¹‹åï¼Œè¿™ä¸ªå…¥é˜Ÿç»“ç‚¹ä¼šç§°ä¸ºæ–°çš„head</p>
</blockquote>
</li>
</ul>
</li>
<li><p>ç„¶åå¦‚æœå‰é©±èŠ‚ç‚¹å¹¶ä¸æ˜¯headï¼Œå³ä½¿æ˜¯ä¹Ÿæ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€çš„è¯ï¼Œå°±åˆ°äº†<code>shouldParkAfterFailedAcquire</code>æ–¹æ³•</p>
<pre><code class="language-java">  /**
   * Checks and updates status for a node that failed to acquire.
   * Returns true if thread should block. This is the main signal
   * control in all acquire loops.  Requires that pred == node.prev.
   *
   * @param pred node&#39;s predecessor holding status
   * @param node the node
   * @return {@code true} if thread should block
   */
  private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
      int ws = pred.waitStatus;
      if (ws == Node.SIGNAL)
          /*
           * This node has already set status asking a release
           * to signal it, so it can safely park.
           */
          return true;
      if (ws &gt; 0) {
          /*
           * Predecessor was cancelled. Skip over predecessors and
           * indicate retry.
           */
          do {
              node.prev = pred = pred.prev;
          } while (pred.waitStatus &gt; 0);
          pred.next = node;
      } else {
          /*
           * waitStatus must be 0 or PROPAGATE.  Indicate that we
           * need a signal, but don&#39;t park yet.  Caller will need to
           * retry to make sure it cannot acquire before parking.
           */
          compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
      }
      return false;
  }</code></pre>
<ul>
<li><p>å¦‚æœå·²ç»è®¾ç½®è¿‡çŠ¶æ€ï¼Œå¹¶ä¸”çŠ¶æ€æ˜¯å¤„äºSIGNALä¸­çš„è¯ï¼Œåˆ™è¿”å›true</p>
</li>
<li><p>å¦‚æœæœ€å¼€å§‹çš„ç»“æ„æ˜¯<code>new Node()--&gt;å½“å‰å…¥é˜Ÿç»“ç‚¹</code>çš„è¯ï¼Œå…¥é˜Ÿç»“ç‚¹çš„å‰é©±<code>new Node()</code>çš„waitStatusæ˜¯0ï¼Œè¿™æ—¶å€™èµ°line: 33ï¼Œç„¶åè¿”å›falseæ¥ç€ç»§ç»­æ­»å¾ªç¯</p>
<blockquote>
<p>ä½†æ˜¯è¿™é‡Œæ¯”è¾ƒå…³é”®ï¼Œç¬¬äºŒæ¬¡å†åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œpredçš„waitStatuså·²ç»æ˜¯SIGNALäº†ï¼Œæ‰€ä»¥è¿™è¶Ÿå‡ºå»ä¹‹åä¼šè¿”å›trueï¼Œçº¿ç¨‹ä¼šparkæ‰ï¼Œé™¤éè¢«ä¸­æ–­æˆ–è€…è¢«å‰é©±unpark</p>
</blockquote>
</li>
<li><p>å¦‚æœå‰é©±çš„çŠ¶æ€å¤§äºé›¶ï¼Œæ„å‘³ç€è¿™ä¸ªå‰é©±å·²ç»è¢«cancelæ‰äº†ï¼Œæ‰€ä»¥åœ¨line:23-26çš„æ—¶å€™åšå‡ºçš„å¤„ç†æ˜¯æ–­å¼€è¿™äº›å‰é©±çš„å¼•ç”¨ï¼Œä¸€ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰è¢«canceläº†çš„å‰é©±ä¸ºæ­¢ï¼Œç„¶åè¿”å›falseï¼›</p>
</li>
</ul>
</li>
<li><p>å¦‚æœ<code>shouldParkAfterFailedAcquire</code>è¿”å›trueï¼Œåˆ™æ„å‘³ç€<strong>å½“å‰å…¥é˜Ÿç»“ç‚¹</strong>çš„çº¿ç¨‹åº”è¯¥è¢«<strong>â€œparkï¼ˆåœç½®ï¼‰â€</strong>æ‰ï¼Œæ‰€ä»¥è¿›å…¥<code>parkAndCheckInterrupt</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æš‚åœçº¿ç¨‹å¹¶ä¸”è¿”å›çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ï¼›è¿™ä¸ªä¸­æ–­æ ‡å¿—çš„è¿”å›å…³ç³»åˆ°æœ€å¼€å§‹çš„<code>acquireQueued</code>æ–¹æ³•æ˜¯å¦ä¼šè¿”å›trueï¼Œå¹¶ä¸”è°ƒç”¨<code>selfInterrupted</code>æ–¹æ³•</p>
</li>
</ul>
<p>ç®€å•æ¥è¯´ï¼Œ<code>aquireQueued</code>æ–¹æ³•è®©å…¥é˜Ÿçš„çº¿ç¨‹è¿›å…¥ä¸€ä¸ªè‡ªæ—‹è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å±•å¼€ä¸€ä¸‹å®ƒçš„ç»“æ„ä¸è¿‡ç¨‹ï¼š</p>
<pre class="nhi">
                                     node.prev=head && tryAcquire(arg)
         AQS       might get sync state             /
    -------------         /      â”Œ------v       â”Œ------v       â”Œ------v
    |           |       Node     |     Node     |     Node     |   Node
    |  { head }-|----&gt;{ prev }&lt;--|---{-prev }&lt;--|---{-prev }&lt;--|---{-prev }
    |           |     { next-}---|--&gt;{ next-}---|--&gt;{ next-}---|--&gt;{ next }
    |  { tail }-|----------------|------|-------|------|-------|------^
    |           |                â””------â”˜       â””------â”˜       â””------â”˜
    -------------
æ³¨æ„ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰ç»“ç‚¹éƒ½åœ¨æ— æ—¶æ— åˆ»åœ°è‡ªæ—‹å½“ä¸­ï¼Œç»“ç‚¹åœ¨ç¬¬äºŒæ¬¡forå¾ªç¯ä¸­ï¼Œå°±éƒ½æ˜¯å¤„äºparkçŠ¶æ€ï¼Œ
     å› ä¸ºä¸€æ¬¡forå¾ªç¯ä¸­çš„shouldParkAfterFailedAcquireå°±å·²ç»æŠŠå‰é©±è®¾ç½®ä¸ºSIGNALäº†ï¼Œ
     ç›´åˆ°ç¬¬äºŒä¸ªç»“ç‚¹ç§°ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”unparkåŸæ¥çš„ç¬¬ä¸‰ä¸ªç»“ç‚¹ï¼Œä»¥æ­¤...
</pre>



<p>å¦‚ç»“æ„é‡Œå±•ç¤ºçš„ä¸€æ ·ï¼Œé™¤äº†è·å–åˆ°åŒæ­¥çŠ¶æ€çš„å¤´èŠ‚ç‚¹ä¹‹å¤–ï¼Œåé¢çš„ç»“ç‚¹éƒ½åœ¨æ’é˜Ÿparkä¸­ï¼Œè¿™ä¸ªç»“è®ºæˆ‘å·²ç»debugè¿‡äº†ï¼Œç¡®å®æ˜¯è¿™æ ·çš„ï¼Œ<strong>è¿™æ ·çœ‹æ¥ï¼Œæ’é˜Ÿä¸­çš„å„ä¸ªç»“ç‚¹çº¿ç¨‹å®ƒä»¬ä¹‹é—´è·å–é”çš„é¡ºåºï¼Œæ˜¯â€œå…¬å¹³çš„â€</strong>ï¼Œ</p>
<p>æœ€åï¼Œç»™å‡ºç‹¬å é”<code>acquire</code>æ–¹æ³•çš„æµç¨‹å›¾ï¼š</p>
<pre><code class="language-flow">st=&gt;start: start
getsycn=&gt;condition: è·å–åŒæ­¥çŠ¶æ€
gennode=&gt;operation: ç”Ÿæˆå…¥é˜Ÿç»“ç‚¹
addwaiter=&gt;operation: åŠ å…¥åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨(CAS)
preishead=&gt;condition: å‰é©±æ˜¯å¤´èŠ‚ç‚¹
getsycn2=&gt;condition: è·å–åŒæ­¥çŠ¶æ€
twait=&gt;operation: çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
behead=&gt;operation: å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹
exit=&gt;operation: é€€å‡º
e=&gt;end: end

st-&gt;getsycn
getsycn(yes)-&gt;exit
getsycn(no)-&gt;gennode
gennode-&gt;addwaiter
addwaiter-&gt;preishead
preishead(yes)-&gt;getsycn2
preishead(no)-&gt;twait
getsycn2(no)-&gt;twait
twait(right)-&gt;preishead
getsycn2(yes)-&gt;behead
behead(left)-&gt;exit(right)
exit-&gt;e</code></pre>
<p><em>æµç¨‹å›¾å¯ä»¥çŸ¥é“é‡Œçš„çº¿æ¡è¿˜éœ€è¦æ³¨æ„ä¸€ä¸ªï¼Œâ€˜çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€â€™åˆ°â€˜å‰é©±æ˜¯å¤´èŠ‚ç‚¹â€™è¿™é‡Œï¼Œæ„ä¹‰æ˜¯ï¼šçº¿ç¨‹è¢«ä¸­æ–­æˆ–è€…å‰é©±ç»“ç‚¹è¢«é‡Šæ”¾</em></p>

          <h5 id="e7290074">release</h5><pre><code class="language-java">public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}</code></pre>
<p>æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§ç»“ç‚¹ï¼Œç„¶ååœ¨è‡ªæ—‹ä¸­çš„åç»§ç»“ç‚¹ä¼šæœ‰æœºä¼šè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œç„¶åè¿›è¡Œä¸Šé¢çš„æµç¨‹å›¾ï¼›</p>

          <h4 id="e607218e">Shared acquire &amp; release</h4><p>å…±äº«å¼çš„æºç é˜…è¯»çœŸæ˜¯<strong>ä¸€é“å¤§å</strong>ï¼Œç½‘ä¸Šçš„è¦ä¹ˆæ²¡è¯´åˆ°é‡ç‚¹ï¼Œè¦ä¹ˆä¸€é€šèƒ¡è¯´ï¼Œè€Œä¸”ç½‘ä¸Šçš„ç‰ˆæœ¬å¤§å¤šéƒ½æ˜¯1.7çš„ï¼Œè™½ç„¶ç›¸è¾ƒ1.8ï¼Œä¹Ÿä»…ä»…åœ¨<code>setHeadAndPropagate</code>ä¸­æŸå¤„å¤šäº†2ä¸ªconditionï¼Œä½†å°±æ˜¯è¿™ä¸ªæ–¹æ³•éƒ½æ²¡äººèƒ½ææ¸…æ¥šåˆ°åº•<strong>â€œpropagateâ€</strong>çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Œç”šè‡³æˆ‘è§‰å¾—1.8å¤šçš„é‚£2ä¸ªconditionæ˜¯ç”¨æ¥è¿«ä¸å¾—å·²å»ä¿®1.7æ—¶ç•™ä¸‹æ¥çš„bugæ‰åŠ ä¸Šå»çš„ï¼Œ<em>Daug Lea</em>å‰è¾ˆçš„æ€æƒ³ç¡®å®ç²¾å·§é«˜æ·±</p>

          <h5 id="48c2910f">tryAcquireShared</h5><p>åˆ†æ<code>acquireShared</code>ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æä¸€ä¸‹<code>tryAcquireShared</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼å¯¹å‰è€…å½±å“éå¸¸å¤§ï¼Œå…³é”®æ˜¯æ³¨é‡Šï¼š</p>
<p>è¿™æ˜¯ç¬¬ä¸€æ®µï¼š</p>
<pre><code>* Attempts to acquire in shared mode. This method should query if
* the state of the object permits it to be acquired in the shared
* mode, and if so to acquire it.
*
* This method is always invoked by the thread performing
* acquire.
* If this method reports failure, the acquire method
* may queue the thread, if it is not already queued, until it is
* signalled by a release from some other thread.</code></pre><blockquote>
<p>è¿™ä¸ªæ–¹æ³•å°è¯•åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–åŒæ­¥çŠ¶æ€ï¼Œæ–¹æ³•åº”è¯¥åœ¨åŒæ­¥å™¨æ”¯æŒå…±äº«æ¨¡å¼çš„æƒ…å†µä¸‹æ‰èƒ½è¢«ä½¿ç”¨</p>
<p>æ–¹æ³•åº”è¯¥åœ¨çº¿ç¨‹è¯·æ±‚è·å–åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼ˆå³call<code>acquire</code>ï¼‰è¢«è°ƒç”¨</p>
<p>å¦‚æœæ–¹æ³•è¿”å›é”™è¯¯ï¼Œé‚£ä¹ˆ<code>acquire</code>æ–¹æ³•ä¼šè®©çº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—</p>
</blockquote>
<p>ç¬¬äºŒæ®µæ˜¯å…³äºå‚æ•°å’Œè¿”å›å€¼</p>
<pre><code>* @param arg the acquire argument. This value is always the one
*        passed to an acquire method, or is the value saved on entry
*        to a condition wait.  The value is otherwise uninterpreted
*        and can represent anything you like.
* @return a negative value on failure; zero if acquisition in shared
*         mode succeeded but no subsequent shared-mode acquire can
*         succeed; and a positive value if acquisition in shared
*         mode succeeded and subsequent shared-mode acquires might
*         also succeed, in which case a subsequent waiting thread
*         must check availability. (Support for three different
*         return values enables this method to be used in contexts
*         where acquires only sometimes act exclusively.)  Upon
*         success, this object has been acquired.</code></pre><blockquote>
<p><strong>å‚æ•°argï¼š</strong>è¿™ä¸ªå€¼ä¹Ÿè®¸æ˜¯1ï¼Œæˆ–è€…æ˜¯ä¿å­˜åœ¨conditionï¼ˆæŸä¸ªåœ°æ–¹- -ï¼‰çš„ä¸€ä¸ªå€¼ï¼Œæˆ–è€…ä½ å¯ä»¥è®¾ç½®ä¸ºä»»æ„ä½ å–œæ¬¢çš„å€¼</p>
<p><strong>è¿”å›å€¼ï¼š</strong></p>
<ul>
<li>å¦‚æœè·å–å¤±è´¥äº†çš„è¯ï¼Œå°±è¿”å›å¤æ•°</li>
<li>åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–æˆåŠŸï¼Œä½†æ˜¯åç»§çš„å…±äº«æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€æ²¡æœ‰æˆåŠŸï¼ˆå¾ˆè¿·å§ï¼Ÿï¼‰ï¼Œè¿”å›0</li>
<li>å…±äº«æ¨¡å¼ä¸‹è·å–æˆåŠŸï¼ŒåæœŸçš„å…±äº«æ¨¡å¼ä¹Ÿè·å–æˆåŠŸï¼Œè¿”å›æ­£æ•°</li>
</ul>
<p>è¿™é‡Œè¯´æ”¯æŒ3ç§æƒ…å†µï¼Œä½†æ˜¯è€çˆ·å­è‡ªå·±åœ¨å†™çš„æ—¶å€™ä¹Ÿæ²¡å¤ªå¤šæƒ³ï¼Œå®é™…ä¸Šè¿ç”¨å½“ä½œä¸€èˆ¬åªæ”¯æŒè´Ÿæ•°ä»£è¡¨ä¸æˆåŠŸï¼Œéè´Ÿæ•°ä»£è¡¨æˆåŠŸï¼Œæ‰€ä»¥å’Œbooleanæ²¡ä»€ä¹ˆåŒºåˆ«- -</p>
</blockquote>

          <h5 id="a2a6d3a8">acquireShared</h5><pre><code class="language-java">public final void acquireShared(int arg) {
    if (tryAcquireShared(arg) &lt; 0)
        doAcquireShared(arg);
}

private void doAcquireShared(int arg) {
    final Node node = addWaiter(Node.SHARED);
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head) {
                int r = tryAcquireShared(arg);
                if (r &gt;= 0) {    // è¿™é‡Œå°±æ˜¯ï¼Œéè´Ÿæ•°å°±æ˜¯ä»£è¡¨æˆåŠŸäº†
                    setHeadAndPropagate(node, r);
                    p.next = null; // help GC
                    if (interrupted)
                        selfInterrupt();
                    failed = false;
                    return;
                }
            }
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}</code></pre>
<p>é¦–å…ˆ<code>addWaiter</code>ï¼Œæ·»åŠ çš„æ˜¯SHAREDæ¨¡å¼çš„ç»“ç‚¹ï¼Œè¿™ç§ç»“ç‚¹çš„modeå¯¹è±¡æ˜¯ä¸€ä¸ª<code>new Node</code></p>
<p>ä¸€ç›´åˆ°line: 25ï¼Œè¿›å…¥è‡ªæ—‹é˜¶æ®µï¼š</p>
<ol>
<li><p>å¦‚æœå‰é©±æ˜¯headï¼Œåˆ™tryä¸€æ¬¡åŒæ­¥çŠ¶æ€ï¼š</p>
<ol>
<li><p>å¦‚æœtryåˆ°äº†<code>arg</code>ä¸ªåŒæ­¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°±è®¾ç½®è¿™ä¸ªåˆšåˆšè·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„ç»“ç‚¹ä¸ºï¼Œheadå¹¶ä¸”<strong>â€œPropagateâ€</strong>ï¼š</p>
<pre><code class="language-java"> private void setHeadAndPropagate(Node node, int propagate) {
     Node h = head; // Record old head for check below
     setHead(node);
     /*
      * Try to signal next queued node if:
      *   Propagation was indicated by caller,
      *     or was recorded (as h.waitStatus either before
      *     or after setHead) by a previous operation
      *     (note: this uses sign-check of waitStatus because
      *      PROPAGATE status may transition to SIGNAL.)
      * and
      *   The next node is waiting in shared mode,
      *     or we don&#39;t know, because it appears null
      *
      * The conservatism in both of these checks may cause
      * unnecessary wake-ups, but only when there are multiple
      * racing acquires/releases, so most need signals now or soon
      * anyway.
      */
     if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 ||
         (h = head) == null || h.waitStatus &lt; 0) {
         Node s = node.next;
         if (s == null || s.isShared())
             doReleaseShared();
     }
 }</code></pre>
<p> è¿™æ®µå…¶å®ä¹Ÿå¾ˆè¿·ï¼Œé¦–å…ˆç”¨<code>h</code>è®°å½•æ—§å¤´ï¼Œç„¶åè®¾ç½®æ–°å¤´ï¼Œå¦‚æœè¯´</p>
<ul>
<li><p>ä¸Šä¸€æ­¥çš„<code>tryAcquireShared</code>æ‹¿åˆ°äº†1ä»¥ä¸Šçš„åŒæ­¥çŠ¶æ€çš„è¯</p>
</li>
<li><p>æ—§å¤´æ˜¯nullçš„è¯</p>
</li>
<li><p>æ—§å¤´çš„<code>waitStatus</code>æ˜¯SIGNAL/CONDITION/PROPAGATEçš„è¯</p>
</li>
<li><p><code>(h = head) == null</code>è¿™æ®µæ›´ä¸çŸ¥æ‰€äº‘ï¼Œå˜æˆæ–°å¤´äº†ä¹‹åï¼Œæ–°å¤´è¿˜èƒ½ä¸ºnullå˜›ï¼Ÿ</p>
</li>
<li><p>æ–°å¤´<code>waitStatus</code>æ˜¯SIGNAL/CONDITION/PROPAGATEçš„è¯</p>
<p>åé¢2ä¸ªæ¡ä»¶æ˜¯1.8æ–°åŠ çš„ï¼Œ1.7æ²¡æœ‰è¿™æ ·çš„ï¼Œä½†æ˜¯çœŸçš„ä¸æ˜¯å¾ˆæ‡‚ä¸ºä»€ä¹ˆä¼šåˆ¤æ–­åé¢2ä¸ªæ¡ä»¶ï¼Œä¹Ÿè®¸æ˜¯ä¸ºäº†å¤„ç†å¹¶å‘ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£æˆ‘è¶Šå‘è§‰å¾—sharedè¿™æ®µçš„ä»£ç å†™çš„å¾ˆä¸ä¸¥è°¨äº†ï¼Œåº”è¯¥æœ‰ç›´æ¥çš„æ–¹æ³•å»å¤„ç†sharedé”çš„</p>
<p>anywayï¼Œæ€»ä¹‹å¦‚æœè¯´æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶çš„è¯ï¼Œä»£è¡¨ç€è¿™ä¸ªæ—¶å€™åº”è¯¥ä»é˜Ÿä¸­<code>doReleaseShared</code>ç»“ç‚¹äº†ï¼Œ</p>
<pre><code class="language-java">/**
* Release action for shared mode -- signals successor and ensures
* propagation. (Note: For exclusive mode, release just amounts
* to calling unparkSuccessor of head if it needs signal.)
*/
private void doReleaseShared() {
  /*
   * Ensure that a release propagates, even if there are other
   * in-progress acquires/releases.  This proceeds in the usual
   * way of trying to unparkSuccessor of head if it needs
   * signal. But if it does not, status is set to PROPAGATE to
   * ensure that upon release, propagation continues.
   * Additionally, we must loop in case a new node is added
   * while we are doing this. Also, unlike other uses of
   * unparkSuccessor, we need to know if CAS to reset status
   * fails, if so rechecking.
   */
  for (;;) {
      Node h = head;
      if (h != null &amp;&amp; h != tail) {
          int ws = h.waitStatus;
          if (ws == Node.SIGNAL) {
              if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                  continue;            // loop to recheck cases
              unparkSuccessor(h);
          }
          else if (ws == 0 &amp;&amp;
                   !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))
              continue;                // loop on failed CAS
      }
      if (h == head)                   // loop if head changed
          break;
  }
}</code></pre>
<p>è¿™ä¸ª<code>doReleaseShared</code>çš„å«ä¹‰æ˜¯ï¼šå¤´ç»“ç‚¹çš„åç»§ç»“ç‚¹æˆ–è®¸å·²ç»parkäº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦unparkå®ƒï¼Œè®©è¿™ä¸ªåç»§<strong>é‡æ–°å¼€å§‹æ­»å¾ªç¯ä»¥å°è¯•è·å–åŒæ­¥çŠ¶æ€</strong>å› ï¼Œä¸º<strong>åœ¨parkçŠ¶æ€çš„æ— æ³•å›åˆ°è‡ªæ—‹ä¸­å°è¯•ç»§ç»­è·å–åŒæ­¥çŠ¶æ€çš„ï¼ï¼ï¼</strong>è¿™äº›ç»“ç‚¹ä¹Ÿè®¸æ˜¯SHAREDæ¨¡å¼çš„ï¼Œä½†æ˜¯å®ƒä»¬å¿…é¡»è¢«unparkä¹‹åï¼Œé‡æ–°å¼€å§‹è‡ªæ—‹ä¹‹åï¼Œæ‰èƒ½å¤Ÿå°è¯•è·å–æ–°çš„åŒæ­¥çŠ¶æ€ï¼</p>
</li>
<li><p><em><code>acquireShared/setHeadAndPropagate/doReleaseShared</code>è¿™ä¸‰ä¸ªæ–¹æ³•åŠ ä¸€èµ·è¿™æ‰æ˜¯Propagateçš„å«ä¹‰*</em></p>
<blockquote>
<p>åŒä¸€æ—¶é—´æœ‰3ä¸ªåŒæ­¥çŠ¶æ€è¢«é‡Šæ”¾ï¼Œé˜Ÿåˆ—ä¸­æœ‰Aã€Bã€Cä¸‰ä¸ªå…±äº«ç»“ç‚¹è¢«parkæ‰ï¼ŒAçš„å‰é©±æœ€åé‡Šæ”¾çš„æ—¶å€™ï¼Œä¼šunparkAç»“ç‚¹ï¼Œå½“Aè·å–åˆ°äº†åŒæ­¥çŠ¶æ€çš„æ—¶å€™ï¼ŒAç»è¿‡<code>acquireShared</code>ï¼Œè¿›å…¥<code>setHeadAndPropagate</code>ï¼Œå°†Aè®¾ç½®ä¸ºheadï¼Œç„¶åéªŒè¯Bæ˜¯sharedæ¨¡å¼äº†ä¹‹åï¼Œè¿›å…¥<code>doReleaseShared</code>ï¼Œè¿™æ—¶å€™åœ¨Aç»“ç‚¹çº¿ç¨‹ä¸­é€šè¿‡æ­»å¾ªç¯çš„æ–¹å¼æœ€ç»ˆunparkBï¼ŒAè¿”å›åˆ°çº¿ç¨‹ç»§ç»­ä½œä¸šï¼›</p>
<p>äºæ˜¯Båˆå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œç„¶åå°†è‡ªå·±è®¾ç½®ä¸ºå¤´ï¼Œç„¶åéªŒè¯Cæ˜¯sharedäº†ä¹‹åï¼Œç„¶åæ­»å¾ªç¯unparkCï¼Œä»¥æ­¤ç±»æ¨....</p>
<p>è¿™ä¹Ÿæ˜¯å’Œç‹¬å ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œç‹¬å æ¯æ¬¡åªéœ€è¦unparkå¤´ç»“ç‚¹çš„åç»§å°±è¡Œäº†ï¼Œå…±äº«æ˜¯å°½å¯èƒ½åœ°ä»é˜Ÿä¼å¼€å§‹ï¼Œå¾€åunparkæ›´å¤šçš„SHAREDç»“ç‚¹ï¼</p>
</blockquote>
<p>æ­¤å¤–ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æœ‰å¦å¤–ä¸€å±‚å«ä¹‰ï¼Œè¿™ä¸ªä¸‹é¢é©¬ä¸Šè¯´åˆ°</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>å¦‚æœä¸æ˜¯headï¼Œåˆ™åº”è¯¥parkå½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«å‰é©±å”¤é†’</p>
</li>
</ol>

          <h5 id="207d69ac">releaseShared</h5><pre><code class="language-java">public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}</code></pre>
<p><code>doReleaseShared</code>åœ¨è¿™é‡Œä½“ç°å‡ºçš„å«ä¹‰æ˜¯ï¼šç¡®ä¿åŒæ­¥çŠ¶æ€è¢«<strong>çº¿ç¨‹å®‰å…¨åœ°é‡Šæ”¾ï¼ˆå½’è¿˜ï¼‰</strong>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•å†…éƒ¨é€šè¿‡CASåŠ å¾ªç¯çš„æ–¹å¼åšè¿™ä¸ªç¡®ä¿ï¼Œå› ä¸ºé‡Šæ”¾æ“ä½œä¼šåŒæ—¶æ¥è‡ªå¤šä¸ªçº¿ç¨‹</p>

          <h3 id="26845fc6">Conclusion</h3><p>è¿™ç¯‡åº”è¯¥æ˜¯å­—æ•°æœ€å¤šçš„blogäº†ï¼Œåˆ†æäº†å¾ˆå¾ˆä¹…æ—¶é—´ï¼ŒèŠ±è´¹çš„ç²¾åŠ›ä¹Ÿæ¯”è¾ƒå¤šï¼Œè€çˆ·å­æ€»æ˜¯åœ¨é«˜å±‚æ¬¡çš„åœ°æ–¹è®¾è®¡é€»è¾‘ï¼Œå¦‚æœä¸å¤šå¤„ä¸€èµ·çœ‹ä»£ç ï¼Œä¼°è®¡å¾ˆéš¾ç†è§£é€»è¾‘è®¾è®¡çš„ç”¨æ„</p>
<p>ç‰¹åˆ«æ˜¯æœ‰çš„æ—¶å€™ï¼Œå³ä½¿æ˜¯ç•…é”€ä¹¦éƒ½ä¸å¤ªä¼šå’Œä½ åˆ†ææ·±ä¸€äº›çš„é“ç†å’Œç»“æ„é€»è¾‘ï¼Œæ¯”å¦‚shareéƒ¨åˆ†å°±æ²¡å¤ªåˆ†æï¼Œç½‘ä¸Šä¹Ÿæœ‰è®¸å¤šåŒè¡Œå°è¯•è¿›è¡Œåˆ†æï¼Œä½†æ˜¯ä¹Ÿæ²¡è®²å‡º<strong>Propagate</strong>çš„çœŸæ­£å«ä¹‰</p>
<hr>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>