<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/myjs/jump-1.2.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">ğŸš€</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <span id="slogan">
            <i id="wolf-logo" style="font-style: normal;" class="mr-4">ğŸŒ‘</i>I'M BACK
        </span>
        <div id="showmore"> &gt; About Me & This Blog</div>
        <div id="showhacknical"> &gt; My Github Analysis</div>
        <div id="toarticles"> &gt; My Tech Articles</div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="series" class="unselectable">
        <span>ç³»</span>
        <span>åˆ—</span>
        <span>æ–‡</span>
        <span>ç« </span>
    </div>
    <div id="seriesbox" class="unselectable">

    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistic</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search">
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3>
            <a name="_root-Introduction" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Introduction
          </h3><p>åœ¨å­¦ä¹ Javaå¹¶å‘ä¸­çš„åŒæ­¥å™¨æºç çš„æ—¶å€™ï¼Œæ³¨é‡Šä¸­æœ‰æåˆ°è¿‡AQSçš„Nodeç»“æ„æ˜¯å‚è€ƒCLHçš„ä¸€ç§å˜ä½“ï¼š</p>
<blockquote>
<p>The wait queue is a variant of a &quot;CLH&quot; (Craig, Landin, and Hagersten) lock queue. </p>
<p>CLH locks are normally used for spinlocks.  We instead use them for blocking synchronizers, but use the same basic tactic of holding some of the control information about a thread in the predecessor of its node.  A &quot;status&quot; field in each node keeps track of whether a thread should block.  </p>
<p>A node is signalled when its predecessor releases.  Each node of the queue otherwise serves as a specific-notification-style monitor holding a single waiting thread. The status field does NOT control whether threads are granted locks etc though.  </p>
<p>A thread may try to acquire if it is first in the queue. But being first does not guarantee success; it only gives the right to contend.  So the currently released contender thread may need to rewait.</p>
<p><strong>To enqueue into a CLH lock, you atomically splice it in as new tail.</strong> </p>
<p><strong>To dequeue, you just set the head field.</strong></p>
 <pre class="nhi">
      +------+  prev +-----+       +-----+
 head |      | &lt;---- |     | &lt;---- |     |  tail
      +------+       +-----+       +-----+
 </pre>

<p>Insertion into a CLH queue requires only a single atomic operation on &quot;tail&quot;, so there is a simple atomic point of demarcation from unqueued to queued. Similarly, dequeuing involves only updating the &quot;head&quot;. </p>
<p>However, it takes a bit more work for nodes to determine who their successors are, in part to deal with possible cancellation due to timeouts and interrupts.</p>
</blockquote>
<p>CLHé”å³Craig, Landin, and Hagersten (CLH) locksï¼ŒCLHé”æ˜¯ä¸€ä¸ªè‡ªæ—‹é”ï¼Œèƒ½ç¡®ä¿æ— é¥¥é¥¿æ€§ï¼Œæä¾›å…ˆæ¥å…ˆæœåŠ¡çš„å…¬å¹³æ€§</p>
<p>CLHé”ä¹Ÿæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹åªåœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹</p>
<p>CLH Lockæ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„è‡ªæ—‹é”ç®—æ³•ä¹‹ä¸€ï¼Œå› ä¸ºé”çš„CASæ“ä½œæ¶‰åŠåˆ°äº†ç¡¬ä»¶çš„é”å®š(é”æ€»çº¿æˆ–è€…æ˜¯é”å†…å­˜)æ‰€ä»¥æ€§èƒ½å’ŒCPUæ¶æ„ä¹Ÿå¯†ä¸å¯åˆ†</p>
<p>CLH Lockæ˜¯ç‹¬å å¼é”çš„ä¸€ç§ï¼Œå¹¶ä¸”æ˜¯ä¸å¯é‡å…¥çš„é”</p>

          <h3>
            <a name="_root-Implement" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Implement
          </h3><pre><code class="language-java">public class ClhSpinLock implements Lock{
    private final ThreadLocal&lt;Node&gt; prev;
    private final ThreadLocal&lt;Node&gt; node;
    private final AtomicReference&lt;Node&gt; tail = new AtomicReference&lt;Node&gt;(new Node());

    public ClhSpinLock() {
        this.node = new ThreadLocal&lt;Node&gt;() {
            protected Node initialValue() {
                return new Node();
            }
        };

        this.prev = new ThreadLocal&lt;Node&gt;() {
            protected Node initialValue() {
                return null;
            }
        };
    }

    /**
     * 1.åˆå§‹çŠ¶æ€ tailæŒ‡å‘ä¸€ä¸ªnode(head)èŠ‚ç‚¹ 
     * +------+ 
     * | head | &lt;---- tail 
     * +------+
     * 
     * 2.lock-threadåŠ å…¥ç­‰å¾…é˜Ÿåˆ—: tailæŒ‡å‘æ–°çš„Nodeï¼ŒåŒæ—¶PrevæŒ‡å‘tailä¹‹å‰æŒ‡å‘çš„èŠ‚ç‚¹
     * +----------+
     * | Thread-A |
     * | := Node  | &lt;---- tail
     * | := Prev  | -----&gt; +------+
     * +----------+        | head |
     *                     +------+ 
     * 
     *             +----------+            +----------+
     *             | Thread-B |            | Thread-A |
     * tail ----&gt;  | := Node  |     --&gt;    | := Node  | 
     *             | := Prev  | ----|      | := Prev  | -----&gt;  +------+
     *             +----------+            +----------+         | head |
     *                                                          +------+ 
     * 3.å¯»æ‰¾å½“å‰nodeçš„prev-nodeç„¶åå¼€å§‹è‡ªæ—‹
     * 
     */
    public void lock() {
        final Node node = this.node.get();
        node.locked = true;
        Node pred = this.tail.getAndSet(node);
        this.prev.set(pred);
        // è‡ªæ—‹
        while (pred.locked);
    }

    public void unlock() {
        final Node node = this.node.get();
        node.locked = false;
        this.node.set(this.prev.get());
    }

    private static class Node {private volatile boolean locked;}
}</code></pre>
<p>CLHçš„ç®—æ³•å®šä¹‰</p>
<blockquote>
<p>the list, the application thread spin only on a local variable, it constantly polling the precursor state, if it is found that the pre release lock end spin.</p>
</blockquote>
<p>åŸºäºlistï¼Œçº¿ç¨‹ä»…åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”ç»“æŸ.</p>
<p>æ‰€ä»¥åœ¨javaä¸­ä½¿ç”¨äº†ThreadLocalä½œä¸ºå…·ä½“å®ç°,AtomicReferenceä¸ºäº†æ¶ˆé™¤å¤šä¸ªçº¿ç¨‹å¹¶å‘å¯¹tailå¼•ç”¨Nodeçš„å½±å“ï¼Œæ ¸å¿ƒæ–¹æ³•lock()ä¸­åˆ†ä¸º3ä¸ªæ­¥éª¤å»å®ç°</p>
<ol>
<li><p>åˆå§‹çŠ¶æ€ tailæŒ‡å‘ä¸€ä¸ªnode(head)èŠ‚ç‚¹</p>
<pre><code> private final AtomicReference&lt;Node&gt; tail = new AtomicReference&lt;Node&gt;(new Node());</code></pre></li>
<li><p>threadåŠ å…¥ç­‰å¾…é˜Ÿåˆ—: tailæŒ‡å‘æ–°çš„Nodeï¼ŒåŒæ—¶PrevæŒ‡å‘tailä¹‹å‰æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œåœ¨javaä»£ç ä¸­ä½¿ç”¨äº†getAndSetå³CASæ“ä½œä½¿ç”¨</p>
<pre><code> Node pred = this.tail.getAndSet(node);
 this.prev.set(pred);</code></pre></li>
<li><p>å¯»æ‰¾å½“å‰çº¿ç¨‹å¯¹åº”çš„nodeçš„å‰é©±nodeç„¶åå¼€å§‹è‡ªæ—‹å‰é©±nodeçš„statusåˆ¤æ–­æ˜¯å¦å¯ä»¥è·å–lock</p>
<pre><code> while (pred.locked);</code></pre></li>
</ol>
<p>åŒç†unlock()æ–¹æ³•ï¼Œè·å–å½“å‰çº¿ç¨‹çš„nodeï¼Œè®¾ç½®lock statusï¼Œå°†å½“å‰nodeæŒ‡å‘å‰é©±node(è¿™æ ·æ“ä½œtailæŒ‡å‘çš„å°±æ˜¯å‰é©±nodeç­‰åŒäºå‡ºé˜Ÿæ“ä½œ).è‡³æ­¤CLH Lockçš„è¿‡ç¨‹å°±ç»“æŸäº†</p>
<hr>
<p>æ›´å¤šçš„å…³äºç®€å•çš„è‡ªæ—‹é”æˆ–è€…MCSé”å¯ä»¥å‚è€ƒï¼š<a href="https://coderbee.net/index.php/concurrent/20131115/577">https://coderbee.net/index.php/concurrent/20131115/577</a></p>
<p>æœ¬æ–‡æ•´ç†è‡ªï¼š</p>
<ol>
<li><a href="https://segmentfault.com/a/1190000007094429">https://segmentfault.com/a/1190000007094429</a></li>
<li><a href="https://blog.csdn.net/bingjing12345/article/details/17789613">https://blog.csdn.net/bingjing12345/article/details/17789613</a></li>
<li><a href="https://www.programering.com/a/MjM5gTNwATE.html">https://www.programering.com/a/MjM5gTNwATE.html</a></li>
</ol>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>