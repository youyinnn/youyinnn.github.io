<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/myjs/jump-1.3.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">ğŸš€</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">ğŸŒ‘</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="e25a21eb">Introduction</h3><p>æˆ‘ä»¬å¯¹Lockå’ŒAQSæœ‰äº†ä¸€å®šçš„äº†è§£äº†ä¹‹åï¼Œå¯ä»¥å°è¯•ç€æ¥è§¦ä¸€äº›Lock+AQSçš„åŸºæœ¬å®ç°äº†ï¼Œæœ¬ç¯‡ä¼šäº†è§£åˆ°æœ€åŸºæœ¬çš„åŒæ­¥ç»„ä»¶<code>ReentrantLock</code>å’Œ<code>ReentrantReadWriteLock</code>ï¼Œå‰è€…æä¾›äº†æ’ä»–é”çš„å®ç°ï¼Œå¹¶ä¸”æ”¯æŒé‡å…¥ï¼Œåè€…åœ¨å‰è€…çš„åŸºç¡€ä¸Šï¼Œæ”¯æŒé”çš„åˆ†çº§ï¼Œå†™é”æ’ä»–è¯»é”å…±äº«ã€‚ç‰¹åˆ«çš„ï¼Œé‡å…¥é”çš„è·å–è¿˜æœ‰å…¬å¹³å’Œéå…¬å¹³ä¹‹åˆ†ï¼Œæˆ‘ä»¬å…ˆä»è¿™éƒ¨åˆ†å…¥æ‰‹ã€‚</p>

          <h4 id="a54a5ee">Fair Lock &amp; Nonfair Lock</h4><p>å…¬å¹³é”ï¼šé”çš„è·å–æ¬¡åºå’Œè¯·æ±‚é”çš„æ—¶é—´é¡ºåºä¸€è‡´ï¼Œå³åœ¨ç»å¯¹çš„æ—¶é—´é‡Œï¼Œç­‰å¾…æ—¶é—´è¶Šä¹…çš„çº¿ç¨‹è¶Šå…ˆè·å–åˆ°é”ã€‚</p>
<p>éå…¬å¹³é”ï¼šé”çš„è·å–å’Œç¬é—´çš„ç«äº‰æœ‰å…³ï¼Œä¸€ç¬é—´è°è¿æ°”å¥½å°±èƒ½è·å–åˆ°é”ï¼Œè€Œä¸”é”çš„è·å–å³åŒæ­¥çŠ¶æ€çš„è·å–ï¼Œåˆšè·å–åˆ°åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ï¼Œå†æ¬¡è·å–åˆ°çŠ¶æ€çš„æœºä¼šæ¯”è¾ƒå¤§ã€‚</p>
<p>è¯´æ˜ï¼šè™½ç„¶éå…¬å¹³é”å¯èƒ½ä¼šé€ æˆâ€œé¥¥é¥¿â€æƒ…å†µï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯éå…¬å¹³é”ç”¨çš„å¤šï¼Œå› ä¸ºå…¬å¹³é”åœ¨é‡Šæ”¾é”åˆå†è·å–é”çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼š<strong>åˆ‡æ¢çº¿ç¨‹</strong>ï¼Œè€Œéå…¬å¹³é”ä¸€æ®µæ—¶é—´å†…å¾ˆå¯èƒ½æ€»æ˜¯é‚£ä¸€ä¸ªçº¿ç¨‹ä¸åœæ”¾é”æŒé”ï¼Œ<strong>çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å°å°±æ„å‘³ç€â€”â€”ååé‡å¤§</strong></p>
<p>å†è¯´å¤šä¸€ç‚¹ï¼Œå…¬å¹³æ€§å’Œéå…¬å¹³æ€§æ˜¯<strong>â€œé’ˆå¯¹æœªå…¥é˜Ÿç»“ç‚¹â€</strong>å’Œ<strong>â€œå·²å…¥é˜Ÿç»“ç‚¹â€</strong>è€Œè¨€ï¼Œä¸Šä¸€ç¯‡æ–‡ç« å·²ç»æåˆ°è¿‡ï¼Œé˜Ÿåˆ—ä¸­çš„ç»“ç‚¹éƒ½æ˜¯å…¬å¹³è·å–é”çš„ï¼Œéµä»FIFOï¼Œè‡³äºå…·ä½“çš„ä½“ç°ï¼Œç»§ç»­å¾€ä¸‹è¯»ï¼Œè¯»åˆ°FairSyncçš„<code>tryAcquire</code>å’Œ<code>hasQueuedPredecessors</code>æ–¹æ³•å°±çŸ¥é“äº†</p>

          <h4 id="d3b7ceda">ReentrantLock</h4><p>é‡å…¥é”å¯ä»¥é€šè¿‡æ„é€ å™¨æ¥å†³å®šå…¬å¹³æœºåˆ¶ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼š</p>
<pre><code class="language-java">/**
 * Creates an instance of {@code ReentrantLock}.
 * This is equivalent to using {@code ReentrantLock(false)}.
 */
public ReentrantLock() {
    sync = new NonfairSync();
}

/**
 * Creates an instance of {@code ReentrantLock} with the
 * given fairness policy.
 *
 * @param fair {@code true} if this lock should use a fair ordering policy
 */
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}</code></pre>
<p>ReentrantLockä¸­æœ‰3ä¸ªç®€å•çš„å†…éƒ¨ç±»ï¼Œ<code>FairSync</code>/<code>NonfairSync</code>ä»¥åŠ<code>Sync</code>ï¼Œåè€…æ˜¯å‰ä¸¤ä¸ªçš„çˆ¶ç±»ï¼Œ</p>
<pre><code class="language-java">/**
 * Base of synchronization control for this lock. Subclassed
 * into fair and nonfair versions below. Uses AQS state to
 * represent the number of holds on the lock.
 */
abstract static class Sync extends AbstractQueuedSynchronizer {
    private static final long serialVersionUID = -5179523762034025860L;

    /**
     * Performs {@link Lock#lock}. The main reason for subclassing
     * is to allow fast path for nonfair version.
     */
    abstract void lock();

    /**
     * Performs non-fair tryLock.  tryAcquire is implemented in
     * subclasses, but both need nonfair try for trylock method.
     */
    final boolean nonfairTryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0) // overflow
                throw new Error(&quot;Maximum lock count exceeded&quot;);
            setState(nextc);
            return true;
        }
        return false;
    }

    protected final boolean tryRelease(int releases) {
        int c = getState() - releases;
        if (Thread.currentThread() != getExclusiveOwnerThread())
            throw new IllegalMonitorStateException();
        boolean free = false;
        if (c == 0) {
            free = true;
            setExclusiveOwnerThread(null);
        }
        setState(c);
        return free;
    }

    // other method..
}</code></pre>
<p>ä¸€ä¸ªæŠ½è±¡çš„lockæ–¹æ³•ï¼Œä»¥åŠä¸€ä¸ªéå…¬å¹³çš„<code>tryAcquire</code>å’Œ<code>tryRelease</code>ï¼Œå¯ä»¥åœ¨è¿™çœ‹åˆ°ï¼Œåœ¨é‡å…¥é”ä¸­ï¼š<strong>stateä»£è¡¨å é”çš„çº¿ç¨‹é‡å…¥æ¬¡æ•°ï¼ˆç”¨å±‚æ•°åº”è¯¥æ›´å¥½ç†è§£ï¼‰</strong></p>
<p>è§‚å¯Ÿ<code>nonfairTryAcquire</code>æ–¹æ³•ï¼Œå½“stateä¸º0çš„æ—¶å€™ï¼Œä»£è¡¨æ²¡æœ‰çº¿ç¨‹è·å–åˆ°é”ï¼Œä½†æ˜¯åŒæ—¶å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹åœ¨ç«äº‰åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥ä½¿ç”¨CASæ¥è®¾ç½®stateï¼Œè®¾ç½®æˆåŠŸçš„çº¿ç¨‹ä¼šè®¾ç½®AQSçš„ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ï¼Œæ­¤æ—¶stateä¸º1ï¼›ä¸‹æ¬¡å†æ¥çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯è‡ªå·±è·å–è‡ªå·±ï¼Œé‚£ä¹ˆç°åœ¨çš„stateåŠ ä¸Šaquireæ•°é‡ï¼Œè®¾ç½®ä¸ºæ–°çš„stateï¼Œå¹¶ä¸”æ­¤æ—¶æ²¡æœ‰ç«äº‰ï¼Œæ‰€ä»¥å¸¸è§„è®¾ç½®stateå³å¯ï¼›</p>
<p>è§‚å¯Ÿ<code>tryRelease</code>æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯æŒé”çº¿ç¨‹æ‰ç”¨çš„è¯ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œå¦åˆ™ç°åœ¨çš„stateå‡å»releasesæ•°é‡ï¼Œç›´åˆ°ä¸º0çš„æ—¶å€™ï¼Œæ‰ç§»é™¤AQSçš„ç‹¬å çº¿ç¨‹ï¼›</p>
<p>å†æ¥çœ‹çœ‹<code>NonfairSync</code></p>
<pre><code class="language-java">/**
 * Sync object for non-fair locks
 */
static final class NonfairSync extends Sync {
    private static final long serialVersionUID = 7316153563782823691L;

    /**
     * Performs lock.  Try immediate barge, backing up to normal
     * acquire on failure.
     */
    final void lock() {
        if (compareAndSetState(0, 1))
            setExclusiveOwnerThread(Thread.currentThread());
        else
            acquire(1);
    }

    protected final boolean tryAcquire(int acquires) {
        return nonfairTryAcquire(acquires);
    }
}</code></pre>
<p>éå¸¸ç®€å•çš„å®ç°ï¼Œå¹¶ä¸”åœ¨<code>lock</code>æ–¹æ³•ä¸­ä¼šå°è¯•ä¸€æ¬¡å¿«é€Ÿåœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–åˆ°å°±è´¼èµšï¼Œè·å–ä¸åˆ°å°±ä¹–ä¹–<code>acquire</code> å»ï¼Œ<code>tryAcquire</code>åˆ™æ˜¯ç›´æ¥è°ƒç”¨çˆ¶ç±»æä¾›çš„éå…¬å¹³<code>nonfairTryAcquire</code></p>
<p>æœ€åæ˜¯<code>FairSync</code></p>
<pre><code class="language-java">/**
 * Sync object for fair locks
 */
static final class FairSync extends Sync {
    private static final long serialVersionUID = -3000897897090466540L;

    final void lock() {
        acquire(1);
    }

    /**
     * Fair version of tryAcquire.  Don&#39;t grant access unless
     * recursive call or no waiters or is first.
     */
    protected final boolean tryAcquire(int acquires) {
        final Thread current = Thread.currentThread();
        int c = getState();
        if (c == 0) {
            if (!hasQueuedPredecessors() &amp;&amp;
                compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0)
                throw new Error(&quot;Maximum lock count exceeded&quot;);
            setState(nextc);
            return true;
        }
        return false;
    }
}</code></pre>
<p>æˆ‘ä»¬åªéœ€è¦æ³¨æ„åˆ°ï¼Œå®ƒçš„<code>tryAcquire</code>æ–¹æ³•å’Œçˆ¶ç±»çš„éå…¬å¹³è·å–å‡ ä¹å¦‚å‡ºä¸€æ’¤ï¼Œä»…æ˜¯åœ¨CASç«äº‰ä¹‹å‰ï¼Œå…ˆè¦åˆ¤æ–­ä¸€ä¸‹å½“å‰çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ä¸­çš„ç»“ç‚¹æ˜¯å¦æœ‰å‰é©±ï¼ˆ<code>hasQueuedPredecessors</code>ï¼‰ï¼Œå¦‚æœæ²¡æœ‰å°±å¯ä»¥å¼€å§‹CASè·å–ï¼Œä¿è¯æ€»æ˜¯æœ€æ—©å…¥é˜Ÿçš„ç»“ç‚¹æœ‰æƒè·å–åŒæ­¥çŠ¶æ€ï¼›</p>
<p>æˆ‘ä»¬å†æ·±å…¥ä¸€ä¸‹<code>hasQueuedPredcessors</code></p>
<pre><code class="language-java">public final boolean hasQueuedPredecessors() {
    // The correctness of this depends on head being initialized
    // before tail and on head.next being accurate if the current
    // thread is first in queue.
    Node t = tail; // Read fields in reverse initialization order
    Node h = head;
    Node s;
    return h != t &amp;&amp;
        ((s = h.next) == null || s.thread != Thread.currentThread());
}</code></pre>
<p>åˆ¤æ–­headæ˜¯å¦ç­‰äºtailï¼š</p>
<ol>
<li><p>è‹¥ç­‰äºï¼Œåˆ™æ¡ä»¶ç»“æŸï¼Œæ–¹æ³•è¿”å›fasle</p>
<blockquote>
<p>ç­‰äºçš„å«ä¹‰æœ‰2å±‚ï¼Œä¸€æ˜¯é˜Ÿåˆ—é‡Œæ²¡æœ‰ä»»ä½•ç»“ç‚¹çš„æ—¶å€™ï¼Œhead=tail=nullï¼Œè¿™æ—¶å€™æ–¹æ³•è¿”å›falseï¼Œä»£è¡¨è¿›å…¥æ–¹æ³•çš„çº¿ç¨‹æ˜¯æ•´ä¸ªç³»ç»Ÿç¬¬ä¸€æ¬¡è®¿é—®è¯¥é”çš„çº¿ç¨‹ï¼Œåˆ™å¯ä»¥è·å–åŒæ­¥çŠ¶æ€ï¼›</p>
<p>äºŒæ˜¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç»“ç‚¹ï¼Œè¿™ä¸ªç»“ç‚¹å³æ˜¯headåˆæ˜¯tailï¼›</p>
</blockquote>
</li>
<li><p>è‹¥ä¸ç­‰äºï¼Œåˆ™çœ‹headæ˜¯å¦æœ‰åç»§ï¼š</p>
<ol>
<li>è‹¥æ²¡æœ‰åç»§ï¼Œåˆ™æ¡ä»¶ç»“æŸï¼Œæ–¹æ³•è¿”å›trueï¼Œå›åˆ°ä¸Šå±‚æ–¹æ³•ï¼Œ<code>tryAcquire</code>è¿”å›falseï¼›</li>
<li>è‹¥æœ‰åç»§ï¼Œå¦‚æœheadçš„åç»§ä¸æ˜¯å½“å‰çº¿ç¨‹çš„è¯ï¼Œæ–¹æ³•è¿”å›trueï¼Œå›åˆ°ä¸Šå±‚æ–¹æ³•ï¼Œ<code>tryAcquire</code>è¿”å›falseï¼›</li>
<li>è‹¥æœ‰åç»§ï¼Œä¸”headåç»§æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™æ–¹æ³•è¿”å›falseï¼Œå›åˆ°ä¸Šå±‚æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼›</li>
</ol>
</li>
</ol>

          <h5 id="2e8d59c4">Real meaning of &quot;fair&quot;</h5><p>è¯»å®Œä¸Šé¢çš„æ–¹æ³•ä¹‹åï¼Œæ¥ä¸‹æ¥è¿™å¥è¯éå¸¸é‡è¦ï¼šä¸ºä»€ä¹ˆä¹‹å‰è¯´ï¼Œå…¬å¹³æ€§å’Œéå…¬å¹³æ€§æ˜¯<strong>â€œé’ˆå¯¹æœªå…¥é˜Ÿç»“ç‚¹â€</strong>å’Œ<strong>â€œå·²å…¥é˜Ÿç»“ç‚¹â€</strong>è€Œè¨€ï¼Ÿå› ä¸º<strong>å·²å…¥é˜Ÿçš„ç»“ç‚¹ä¹‹é—´ä¸å­˜åœ¨ç«äº‰</strong>ï¼Œç«äº‰ä»…ä»…æ˜¯é˜Ÿåˆ—å‰å‡ ä¸ªç»“ç‚¹å’Œæœªå…¥é˜Ÿçš„æ–°çº¿ç¨‹è€Œè¨€ï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å…¬å¹³é”ï¼Œæœªå…¥é˜Ÿçš„æ–°çº¿ç¨‹åœ¨<code>hasQueuePredecessors</code>æ–¹æ³•ä¹‹åï¼Œè‚¯å®šæ˜¯falseï¼Œå¯¼è‡´<code>tryAcquire</code>æ–¹æ³•å¿…å®šè¿”å›falseï¼Œå¯¼è‡´è¿™ä¸ªæ–°çº¿ç¨‹å¿…å®šç»„æˆç»“ç‚¹ç„¶åå…¥é˜Ÿæ’é˜Ÿï¼Œ<strong>å³ä¸å…¥é˜Ÿçš„çº¿ç¨‹æ²¡æœ‰å‚ä¸åŒæ­¥èµ„æºç«äº‰çš„æƒåˆ©</strong>ï¼›</li>
<li>å¦‚æœæ˜¯éå…¬å¹³é”ï¼Œæœªå…¥é˜Ÿçš„æ–°çº¿ç¨‹æœ‰æœºä¼šå’Œå·²å…¥é˜Ÿçš„ä¸€èµ·ç«äº‰åŒæ­¥èµ„æºï¼›æ‰€ä»¥æ‰å«éå…¬å¹³ï¼</li>
</ul>
<p>æ‰€ä»¥ä¸è¦è¯¯è§£éå…¬å¹³é”çš„æƒ…å†µä¸‹ï¼Œåæ’é˜Ÿçš„ç»“ç‚¹çº¿ç¨‹ä¹Ÿèƒ½å¾ˆ<strong>â€œä¸å…¬å¹³â€</strong>åœ°æ¯”å…ˆæ’é˜Ÿçš„ç»“ç‚¹çº¿ç¨‹å…ˆè·å¾—åŒæ­¥çŠ¶æ€ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼›</p>

          <h4 id="e99414ec">ReentrantReadWriteLock</h4><p>åœ¨Lockæ¥å£ä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­‰å¾…é€šçŸ¥çš„è®¾è®¡æœºåˆ¶å¯ä»¥ç®€å•åœ°å®ç°ä¸€ä¸ªè¯»å†™åœºæ™¯ï¼Œå½“å†™æ“ä½œå¼€å§‹çš„æ—¶å€™ï¼Œæ‰€æœ‰åç»­è¯»å†™æ“ä½œéƒ½è¿›å…¥ç­‰å¾…ï¼Œå†™æ“ä½œå®Œæˆä¹‹åï¼Œé€šçŸ¥å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼›åŸºäºè¿™æ ·çš„é€»è¾‘ï¼Œæ‰èƒ½é¿å…è„è¯»</p>
<p>æ‰€ä»¥è¯»å†™é”çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š<strong>å†™é”çš„ä¼˜å…ˆåº¦é«˜äºè¯»é”ï¼Œå¯ä»¥å¤šè¯»ï¼Œåªèƒ½å•å†™ï¼›</strong></p>
<p><strong>æ¢å¥è¯è¯´ï¼Œå†™é”æ˜¯ç‹¬å é”ï¼Œè¯»é”æ˜¯å…±äº«é”</strong></p>
<p>ä½¿ç”¨è¯»å†™é”çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨è¯»æ“ä½œçš„æ—¶å€™è·å–è¯»é”ï¼Œå†™æ“ä½œçš„æ—¶å€™è·å–å†™é”å°±å¯ä»¥äº†ï¼Œæ¯”<code>synchronized</code>å…³é”®å­—åŠ ç­‰å¾…é€šçŸ¥æ–¹æ³•æ›´åŠ ç®€å•æ˜äº†</p>
<p><code>ReentrantReadWirteLock</code>æ˜¯è¯»å†™é”çš„ä¸€ç§ï¼Œå…¶ç‰¹æ€§å¦‚ï¼š</p>
<ul>
<li>å¯é‡å…¥</li>
<li>å…¬å¹³æ€§é€‰æ‹©</li>
<li>éµå¾ªè·å–å†™é”ã€è·å–è¯»é”å†é‡Šæ”¾å†™é”çš„é¡ºåºï¼Œå†™é”å¯é™çº§</li>
</ul>
<p>å¦å¤–å®ƒè¿˜æä¾›äº†å¤–éƒ¨ç›‘æ§å†…éƒ¨é”çŠ¶æ€çš„æ–¹æ³•ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>int getReadLockCount()</code></td>
<td><strong>è¿”å›å½“å‰è¯»é”è¢«è·å–åˆ°çš„æ¬¡æ•°</strong>ï¼Œè¯¥æ¬¡æ•°ä¸ç­‰äºè·å–è¯»é”çš„çº¿ç¨‹æ•°ï¼Œæ¯”å¦‚ä»…ä¸€ä¸ªçº¿ç¨‹è¿ç»­é‡å…¥äº†næ¬¡ï¼Œåˆ™è¿”å›nï¼›è¯¥æ–¹æ³•ä¼šè¿”å›<strong>æ‰€æœ‰çº¿ç¨‹æŒæœ‰çš„å½“å‰è¯»é”çš„å±‚æ•°</strong>ï¼Œæ¯”å¦‚çº¿ç¨‹Aè·å–3æ¬¡ï¼Œé‡Šæ”¾1æ¬¡ï¼Œçº¿ç¨‹Bè·å–5æ¬¡é‡Šæ”¾2æ¬¡ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¿”å›3-1+5-2=<strong>5å±‚</strong>ï¼›</td>
</tr>
<tr>
<td><code>int getReadHoldCount()</code></td>
<td><strong>è¿”å›å½“å‰çº¿ç¨‹è·å–åˆ°è¯»é”çš„æ¬¡æ•°</strong>ï¼Œè¯¥æ–¹æ³•åœ¨Java6ä¹‹ååŠ å…¥ï¼Œé€šè¿‡<strong>ThreadLocal</strong>å®ç°ï¼›è¯¥æ–¹æ³•è¿”å›<strong>å½“å‰çº¿ç¨‹æŒæœ‰è¯¥é”çš„å±‚æ•°</strong>ï¼Œæ¯”å¦‚çº¿ç¨‹Aè·å–è¯¥é”5æ¬¡é‡Šæ”¾<strong>2å±‚</strong>ï¼Œåˆ™åœ¨Aé”è¯¥æ–¹æ³•è¿”å›3ï¼ŒåŒæ—¶Bçº¿ç¨‹è·å–è¯¥é”4æ¬¡é‡Šæ”¾4æ¬¡ï¼Œåˆ™åœ¨Bçº¿ç¨‹è¯¥æ–¹æ³•è¿”å›<strong>0å±‚</strong>ï¼›</td>
</tr>
<tr>
<td><code>boolean isWirteLocked()</code></td>
<td><strong>åˆ¤æ–­å†™é”æ˜¯å¦è¢«è·å–åˆ°ï¼›</strong></td>
</tr>
<tr>
<td><code>int getWriteHoldCount()</code></td>
<td><strong>åˆ¤æ–­å½“å‰å†™é”è¢«è·å–çš„æ¬¡æ•°ï¼›</strong></td>
</tr>
</tbody></table>

          <h5 id="1e8ba163">Read Write State Design</h5><p>æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹ï¼Œå¯¹äºä¸€ä¸ªè¯»å†™é”æ¥è¯´ï¼Œå®ƒåº”å½“å°†è¯»å†™åˆ†ç¦»ä¸º2æŠŠé”ï¼Œä½†æ˜¯è¯»å†™é”çš„æ’é˜Ÿåº”è¯¥æ’åœ¨åŒä¸€é˜Ÿï¼Œæ‰€ä»¥è¯»å†™é”çš„AQSåº”è¯¥æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åœ¨ä¸€ä¸ªAQSå®ä¾‹ä¸Šçš„ä¸€ä¸ªstateå˜é‡ä¸­è¡¨ç¤ºè¯»ä¸å†™ä¸¤ç§åŒæ­¥çŠ¶æ€ï¼Ÿè€çˆ·å­ç»™å‡ºäº†è¿™æ ·çš„ç­”æ¡ˆï¼š</p>
<pre class="nhi">
    int value
    |&lt;-----------------------------32------------------------------&gt;|
    â”Œ---------------------------------------------------------------â”
    |0|0|0|0|0|0|0|0|0|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|1|1|
    â””---------------------------------------------------------------â”˜
                    |                                 â†“
                    |                â”Œ-------------------------------â”
                    â†“                |0|0|0|0|0|0|0|0|0|0|0|0|0|0|1|1|
    â”Œ-------------------------------â”â””-------------------------------â”˜
    |0|0|0|0|0|0|0|0|0|0|0|0|0|0|1|0|               ä½16ä½è¡¨ç¤ºå†™çŠ¶æ€ = 3
    â””-------------------------------â”˜
                   é«˜16ä½è¡¨ç¤ºè¯»çŠ¶æ€ = 2
</pre>

<p>é€šè¿‡ä½è¿ç®—ï¼Œå‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸ºSï¼Œé‚£ä¹ˆå†™çŠ¶æ€å°±ç­‰äºS &amp; 0x0000FFFFï¼ˆé«˜16ä½æ¸…é›¶ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äºS &gt;&gt;&gt; 16ï¼ˆæ— ç¬¦å·è¡¥ä½0å³ç§»16ä½ï¼‰</p>
<p>å½“å†™çŠ¶æ€è¦å¢åŠ 1çš„æ—¶å€™ï¼Œç›´æ¥S + 1ï¼Œå½“è¯»çŠ¶æ€è¦å¢åŠ 1çš„æ˜¯ï¼Œç›´æ¥S + 0x00010000å°±è¡Œ</p>

          <h5 id="8b5c222f">Structure</h5><pre><code class="language-java">public class ReentrantReadWriteLock
        implements ReadWriteLock, java.io.Serializable {

    private final ReentrantReadWriteLock.ReadLock readerLock;
    private final ReentrantReadWriteLock.WriteLock writerLock;
    final Sync sync;

    public ReentrantReadWriteLock() {this(false);}
    public ReentrantReadWriteLock(boolean fair) {
        sync = fair ? new FairSync() : new NonfairSync();
        readerLock = new ReadLock(this);
        writerLock = new WriteLock(this);
    }

    public ReentrantReadWriteLock.WriteLock writeLock() { return writerLock; }
    public ReentrantReadWriteLock.ReadLock  readLock()  { return readerLock; }

    // ...
}</code></pre>
<p>è¿™æ˜¯é‡å…¥è¯»å†™é”çš„æ•´ä½“ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ°ReentrantReadWriteLockä»…ä»…åªæ˜¯å®ç°äº†ReadWriteLockæ¥å£è€Œå·²ï¼Œè¿™ä¸ªæ¥å£ä»…å®šä¹‰äº†è·å–ReadLockå’ŒWriteLockçš„æ–¹æ³•ï¼ŒçœŸæ­£çš„é”å®ç°æ˜¯<code>ReentrantReadWriteLock.ReadLock</code>å’Œ<code>ReentrantReadWriteLock.WriteLock</code>ï¼Œè€Œè¿™ä¸¤ä¸ªé”å®ç°ï¼Œç”¨çš„æ˜¯åŒä¸€ä¸ª<code>Sync</code>å®ä¾‹ï¼Œ<code>Sync</code>å®ä¾‹å³å®ç°äº†AQSçš„å…¬å¹³é”æˆ–è€…éå…¬å¹³é”</p>

          <h5 id="57694f90">Fair &amp; NonFair</h5><p>æˆ‘ä»¬å…ˆæ¥çœ‹éå…¬å¹³é”å’Œå…¬å¹³é”çš„å®ç°ï¼š</p>
<pre><code class="language-java">static final class NonfairSync extends Sync {
    private static final long serialVersionUID = -8159625535654395037L;
    final boolean writerShouldBlock() {
        return false; // writers can always barge
    }
    final boolean readerShouldBlock() {
        return apparentlyFirstQueuedIsExclusive();
    }
}

static final class FairSync extends Sync {
    private static final long serialVersionUID = -2274990926593161451L;
    final boolean writerShouldBlock() {return hasQueuedPredecessors();}
    final boolean readerShouldBlock() {return hasQueuedPredecessors();}
}</code></pre>
<p>è¯»å†™é”ä¸­çš„å…¬å¹³æ€§ä¸»è¦ä½“ç°åœ¨æ˜¯å¦è¦é˜»å¡è¯»å†™çº¿ç¨‹è¿™æ–¹é¢ï¼Œå¯¹äºå…¬å¹³é”è€Œè¨€ï¼Œæ— è®ºè¯»å†™çº¿ç¨‹ï¼Œéƒ½è¦åˆ¤æ–­<code>hasQueeudPredecessors</code>è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸Šé¢è®²è¿‡äº†ï¼Œå…³é”®æ˜¯éå…¬å¹³é”ï¼Œå¯¹äºå†™é”æ˜¯å¦åº”è¯¥blockæ¥è¯´ï¼Œå®ƒæ€»æ˜¯ä¸åº”è¯¥è¢«blockä½ï¼Œè€Œè¯»é”åˆ™éœ€è¦åˆ¤æ–­<code>apparentlyFirstQueuedIsExclusive</code>æ–¹æ³•ï¼Œ</p>
<pre><code class="language-java">final boolean apparentlyFirstQueuedIsExclusive() {
    Node h, s;
    return (h = head) != null &amp;&amp;
        (s = h.next)  != null &amp;&amp;
        !s.isShared()         &amp;&amp;
        s.thread != null;
}</code></pre>
<p>å¦‚æœé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç­‰å¾…ç»“ç‚¹æ˜æ˜¾æ˜¯æ˜¯ç‹¬å å¼é”çš„ç»“ç‚¹çš„è¯ï¼Œå°±è¿”å›trueï¼Œä¸¤ä¸ªæ–¹æ³•è¿èµ·æ¥çš„æ„æ€æ˜¯ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç»“ç‚¹æ˜¯å†™é”ï¼ˆç‹¬å é”ï¼‰çš„è¯ï¼Œè¯»é”åº”è¯¥è¢«Blockä½</p>

          <h5 id="cbb26554">Sync in ReentrantReadWriteLock</h5><pre><code class="language-java">abstract static class Sync extends AbstractQueuedSynchronizer {
    static final int SHARED_SHIFT   = 16;
    static final int SHARED_UNIT    = (1 &lt;&lt; SHARED_SHIFT);
    static final int MAX_COUNT      = (1 &lt;&lt; SHARED_SHIFT) - 1;
    static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1;

    static int sharedCount(int c)    { return c &gt;&gt;&gt; SHARED_SHIFT; }
    static int exclusiveCount(int c) { return c &amp; EXCLUSIVE_MASK; }

    Sync() {
        readHolds = new ThreadLocalHoldCounter();
        setState(getState()); // ensures visibility of readHolds
    }

    abstract boolean readerShouldBlock();
    abstract boolean writerShouldBlock();

    // .. HolderCounter ç›¸å…³æ–¹æ³•æš‚æ—¶ç•¥

    protected final boolean tryRelease(int releases) { 
        // .. 
    }
    protected final boolean tryAcquire(int acquires) {
        // ..
    }
    protected final boolean tryReleaseShared(int unused) {
        // ..
    }
    protected final int tryAcquireShared(int unused) {
        // ..
    }
    final int fullTryAcquireShared(Thread current) {
        // ..
    }
    final boolean tryWriteLock() {
        // ..
    }
    final boolean tryReadLock() {
        // ..
    }

    // .. é”çŠ¶æ€ ç›¸å…³æ–¹æ³•æš‚æ—¶ç•¥

    final int getCount() { return getState(); }
}</code></pre>
<p>é‡å…¥è¯»å†™é”ä¸­çš„<code>Sync</code>ç±»æä¾›çš„åŠŸèƒ½æ¯”è¾ƒå¤šï¼Œå®ƒåŒæ—¶å®ç°äº†è¯»é”å’Œå†™é”çš„ç®¡ç†æ“ä½œï¼Œæˆ‘ä»¬å…ˆåˆ†æè¿™éƒ¨åˆ†ï¼Œç•¥å»çš„éƒ¨åˆ†æˆ‘åœ¨æ³¨é‡Šä¸­è¯´æ˜äº†</p>
<p>è¯»å†™çŠ¶æ€çš„ç®¡ç†å°±æ˜¯é€šè¿‡ä½è¿ç®—å»å®ç°çš„ï¼Œè¯»å†™é”çš„å±‚æ•°ä¹Ÿæ˜¯é€šè¿‡ä½è¿ç®—stateå˜é‡ç®—å‡ºæ¥çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼›å†™é”çš„tryReleaseæ–¹æ³•å’Œ<code>ReentrantLock</code>åŸºæœ¬ä¸€è‡´ï¼›</p>
<p>æˆ‘ä»¬æ¥ç€çœ‹å†™é”çš„tryï¼š</p>
<pre><code class="language-java">protected final boolean tryAcquire(int acquires) {
    Thread current = Thread.currentThread();
    int c = getState();
    int w = exclusiveCount(c);
    if (c != 0) {
        // (Note: if c != 0 and w == 0 then shared count != 0)
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        if (w + exclusiveCount(acquires) &gt; MAX_COUNT)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        // Reentrant acquire
        setState(c + acquires);
        return true;
    }
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    setExclusiveOwnerThread(current);
    return true;
}</code></pre>
<p>è€çˆ·å­ç‰¹åœ°å†™ä¸‹äº†ä¸€æ®µWalkThroughæ³¨é‡Šï¼ŒæŒ‡å‡ºäº†æœ¬æ–¹æ³•è¦å¤„ç†çš„æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœè¯»å†™çŠ¶æ€éƒ½ä¸ä¸ºé›¶ï¼Œä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥AQSçš„ç‹¬å çº¿ç¨‹ï¼Œåˆ™ä¸èƒ½è·å–å†™é”ï¼›</li>
<li>å¦‚æœçŠ¶æ€æ»¡å€¼äº†ï¼Œä¹Ÿè·å–ä¸äº†å†™é”ï¼›</li>
<li>å¦‚æœä¸æ˜¯ä¸Šé¢2ç§æƒ…å†µï¼Œåˆ™è¯¥çº¿ç¨‹åº”è¯¥åœ¨å…¬å¹³æ€§çš„æŒ‡å¯¼ä¸‹<code>writerShouldBlock</code>åˆæ³•ç«äº‰ç‹¬å é”ï¼›</li>
</ol>
<p>å†æ¥çœ‹è¯»é”çš„ï¼Œå†çœ‹è¯»é”ä¹‹å‰ï¼Œæˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹<code>Sync</code>çš„å‡ ä¸ªå˜é‡å’Œç±»ï¼š</p>
<pre><code class="language-java">static final class HoldCounter {
    int count = 0;
    // Use id, not reference, to avoid garbage retention
    final long tid = getThreadId(Thread.currentThread());
}

static final class ThreadLocalHoldCounter extends ThreadLocal&lt;HoldCounter&gt; {
    public HoldCounter initialValue() {return new HoldCounter();}
}

private transient ThreadLocalHoldCounter readHolds;

private transient HoldCounter cachedHoldCounter;

private transient Thread firstReader = null;
private transient int firstReaderHoldCount;</code></pre>
<p>æœ‰ä¸€ä¸ª<code>HoldCounter</code>ç±»ï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªçº¿ç¨‹è‡ªå·±çš„è¯»å±‚æ•°ï¼Œç„¶åé€šè¿‡ThreadLocalæ¥ç®¡ç†</p>
<ul>
<li><code>readHolds</code>ï¼šä¸€ä¸ªThreadLocalå®ä¾‹ï¼Œä¿å­˜äº†æ‰€æœ‰è¯»çº¿ç¨‹çš„HoldCounter</li>
<li><code>cachedHoldCounter</code>ï¼šè¡¨ç¤ºæœ€åä¸€ä¸ªæˆåŠŸacquireåˆ°readLockçš„çº¿ç¨‹çš„holdCount</li>
<li><code>firstReader</code>ï¼šæ˜¯ç¬¬ä¸€ä¸ªacquireåˆ°è¯»é”çš„çº¿ç¨‹</li>
<li><code>firstReaderHoldCount</code>ï¼šæ˜¯<code>firstReader</code>çš„holdCount</li>
</ul>
<p>ç„¶åæ˜¯è¯»tryï¼š</p>
<pre><code class="language-java">protected final int tryAcquireShared(int unused) {
    Thread current = Thread.currentThread();
    int c = getState();
    if (exclusiveCount(c) != 0 &amp;&amp;
        getExclusiveOwnerThread() != current)
        return -1;
    int r = sharedCount(c);
    if (!readerShouldBlock() &amp;&amp;
        r &lt; MAX_COUNT &amp;&amp;
        compareAndSetState(c, c + SHARED_UNIT)) {
        if (r == 0) {
            firstReader = current;
            firstReaderHoldCount = 1;
        } else if (firstReader == current) {
            firstReaderHoldCount++;
        } else {
            HoldCounter rh = cachedHoldCounter;
            if (rh == null || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            else if (rh.count == 0)
                readHolds.set(rh);
            rh.count++;
        }
        return 1;
    }
    return fullTryAcquireShared(current);
}</code></pre>
<p>WalkThroughï¼š</p>
<ol>
<li>å¦‚æœå†™é”è¢«å…¶å®ƒçº¿ç¨‹è·å–äº†ï¼Œåˆ™ä¸èƒ½è·å–è¯»é”ï¼›</li>
<li>å¦åˆ™å°±åœ¨å…¬å¹³æ€§çš„æŒ‡å¯¼ä¸‹<code>writerShouldBlock</code>ï¼Œå¦‚æœå…è®¸ç«äº‰ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦è¶…é‡è¯»ï¼Œå¦‚æœæ²¡è¶…é‡ï¼Œåˆ™å°è¯•CASè®¾ç½®è¯»çŠ¶æ€ï¼Œè¿™ä¸‰ä¸ªæ¡ä»¶è¿‡äº†ä¹‹åï¼Œline:11~line:24æ˜¯å¿«é€Ÿåœ°è¿›è¡ŒtryAcquireSharedï¼Œå®ƒå¹¶æ²¡æœ‰æ£€æŸ¥é‡å…¥æƒ…å†µä¸‹çš„acquireï¼Œæ‰€ä»¥å®ƒå°†å®Œæ•´åœ°holdCountæ£€æŸ¥ç­‰å·¥ä½œæ¨è¿Ÿåˆ°äº†<code>fullTryAcquireShared</code>ä¸­å»äº†ï¼Œå› ä¸ºå…¸å‹çš„æƒ…å†µä¸‹éƒ½æ˜¯éé‡å…¥åœ°ä½¿ç”¨ï¼›</li>
<li>å¦‚æœå‰2æ­¥éƒ½ä¸å¯¹ï¼Œé‚£ä¹ˆå°±å¼€å§‹å®Œæ•´çš„<code>fullTryAcquireShared</code>ï¼Œå®ƒå°†ä¼šå¤„ç†ä¹‹å‰çš„CASå¤±è´¥ï¼Œå·²ç»ç¬¬äºŒæ­¥æ²¡æœ‰å¤„ç†å¥½çš„è¯»é‡å…¥çš„æƒ…å†µï¼›</li>
</ol>
<p>å…³äº<code>fullTryAcquireShared</code>çš„æ›´è¯¦ç»†çš„é€»è¾‘ï¼Œæˆ‘è§‰å¾—æ¯”è¾ƒå¤æ‚ï¼Œä¸å¤ªæƒ³æ·±ç©¶ï¼Œåˆ°æ­¤ä¸ºæ­¢</p>
<p>æœ€åå›åˆ°<code>Sync</code>ç±»æœ€å2ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>tryWriteLock</code>ï¼šå’Œ<code>tryAcquire</code>ç›¸æ¯”ä»…ä»…å°‘äº†<code>writerShouldBlock</code></li>
<li><code>tryReadLock</code>ï¼šå’Œ<code>tryAcquire</code>ç›¸æ¯”ä»…ä»…å°‘äº†<code>readerShouldBlock</code></li>
</ul>

          <h5 id="80ffda47">ReadLock &amp; WriteLock in ReentrantReadWirteLock</h5><p>å¤§è‡´è¯»ä¸‹äº†ä¸Šé¢çš„<code>Sync</code>ä¹‹åï¼Œå‰©ä¸‹çš„<code>ReadLock</code>&amp; <code>WriteLock</code>å…¶å®å°±å¾ˆç®€å•äº†</p>
<pre><code class="language-java">public static class ReadLock implements Lock, java.io.Serializable {
    private final Sync sync;
    protected ReadLock(ReentrantReadWriteLock lock) {
        sync = lock.sync;
    }
    public void lock() {sync.acquireShared(1);}
    public boolean tryLock() {return sync.tryReadLock();}
    public void unlock() {sync.releaseShared(1);}

    // å…¶ä½™releaseã€ä¸­æ–­acquireã€è¶…æ—¶ã€çŠ¶æ€ç›¸å…³æ–¹æ³•ç•¥
}

public static class WriteLock implements Lock, java.io.Serializable {
    private final Sync sync;
    protected WriteLock(ReentrantReadWriteLock lock) {
        sync = lock.sync;
    }
    public void lock() {sync.acquire(1);}
    public boolean tryLock() {return sync.tryWriteLock();}
    public void unlock() {sync.release(1);}

    // å…¶ä½™releaseã€ä¸­æ–­acquireã€è¶…æ—¶ã€çŠ¶æ€ç›¸å…³æ–¹æ³•ç•¥
}</code></pre>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>