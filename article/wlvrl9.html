<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script>
        if (location.hostname === 'youyinnn.github.io' && returnCitySN.cname === 'CHINA') {
            location.href = 'https://youyinnn.gitee.io' + location.pathname
        }
    </script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">


    <script src="/resources/resources.js"></script>
    <script src="/myjs/import.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg em-svg em-rocket"></button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <span id="slogan">
            <i id="wolf-logo" class="em-svg em-new_moon mr-4"></i>I'M BACK
        </span>
        <div id="showmore"> &gt; About Me & This Blog</div>
        <div id="showhacknical"> &gt; My Github Analysis</div>
        <div id="toarticles"> &gt; My Tech Articles</div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="series" class="unselectable">
        <span>系</span>
        <span>列</span>
        <span>文</span>
        <span>章</span>
    </div>
    <div id="seriesbox" class="unselectable">

    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistic</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Site running days:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Total article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Char count:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Category count:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tag count:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search">
            <div class="input-group-append">
                <button id="cleanbut" class="btn" type="button" title="clear search">cls</button>
                <button id="categories" class="btn" type="button">cates</button>
                <button id="tags" class="btn" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn" type="button" title="search">sch</button>
            </div>
        </div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3>
            <a name="_root-Introduction" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Introduction
          </h3><p>之前在搜OOM的时候，无意中发现了<a href="https://plumbr.io/">https://plumbr.io/</a>这个网站，它们的产品就是做内存监控工具之类的，于是官网上也有很多关于JVM的GC方面的技术博客，简直和挖到宝藏了一样- -</p>
<p>本篇主要是针对对象在堆上的分代和GC事件再做一些细致的了解，主要也是参考网站里的内容</p>

          <h3>
            <a name="_root-Object Generation" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Object Generation
          </h3><p>从我们熟悉的开始，堆内存大致可以分为三个区域，Young——新生代、Turned——老年代、PermGen——永久代</p>
<p>其中新生代里又默认以8：1：1分为Eden：Survivor：Survivor</p>
<p><img src="https://image.youyinnn.top/20190318213039.png" alt=""></p>

          <h4>
            <a name="_root-Eden" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Eden
          </h4><p>在以前一篇<a href="https://youyinnn.github.io/?to=post&amp;number=70">关于JVM的对象创建与访问</a>里提到过的TLAB（Thead Local Allocatipn Buffer），它主要用于解决对象分配的时候需要先划定一些内存空间，一个内存空间仅允许一个线程进行操作，这样就可以避免用同步的<strong>高耗时</strong>代价去保证对象分配的正常进行</p>
<p>于是Eden空间进一步划分一个或者多个TLAB区域，并且保留一块公共区域，当TLAB空间不够分配对象的时候，会选择到公共区域继续分配，如果这里也没有空间了的话，那就会出发一次年轻代的GC，也就是<strong>Minor GC</strong></p>
<p>这里有个GC的细节，也是之前没提到过的，我们说GC的基本操作是，扫描引用链，然后清除掉和根引用无关的对象，但是我们需要知道，对象之间的引用是可以跨代的，比如新生代对象可以挂在老年代对象上，所以一次直白的<strong>Reachability Analysis</strong>，可能会跨代进行</p>
<p><img src="https://image.youyinnn.top/20190318214251.png" alt=""></p>
<p>但是这样做的话，<strong>分代GC</strong>就没有意义了，于是JVM在这里使用了一个小伎俩：<em>card-marking</em>，详细可以参考<a href="http://psy-lob-saw.blogspot.com/2014/10/the-jvm-write-barrier-card-marking.html">The JVM Write Barrier - Card Marking</a>，JVM用这个算法粗略地将Eden区的有可能有跨代引用的对象进行标记，然后把它们移到Survivor区，然后剩下的对象就容易清理掉了——是不是很眼熟？这就是<strong>标记-复制</strong>算法</p>

          <h4>
            <a name="_root-Survivor" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Survivor
          </h4><p>紧接着Eden，是两个Survivor区，这两个区域也各自拥有姓名，<strong>&quot;from&quot;</strong>和<strong>&quot;to&quot;</strong>，前面也提到过了，其中一个区域应该总是空的，所以实际上Eden区能用的最大空间是分配的<strong>90%</strong></p>
<p>当年轻代开始GC的时候，所有存活的年轻代会从Eden和from区域复制到to区域，有的年轻代对象也会从from区域直接分配到老年代，因为在这存活了15次，然后原先的from和to会互换身份；</p>
<p><img src="https://image.youyinnn.top/20190318223935.png" alt=""></p>
<p>再提一嘴，15次是默认值，可以用参数调整，然后大对象会更早的进入老年代，不受age限制，这个在前面也说过了</p>

          <h4>
            <a name="_root-Old Generation" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Old Generation
          </h4><p>这部分的对象大多数长期存活的，或者是占用空间有点大的对象，而这里的GC算法也并不能简单地进行<strong>标记-复制</strong>，而是尽可能的用移动去减小对象之间的碎片空间</p>
<p>老年代的回收算法通常是根据不同的基础去确定的，但是原理上都是如下步骤：</p>
<ul>
<li>根据GC Root，为对象标记可达性检测；</li>
<li>删除不可达对象；</li>
<li>压缩这些存活对象，让他们尽量靠近彼此，靠近空间的开端；</li>
</ul>

          <h4>
            <a name="_root-PermGen &amp; Metaspace" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            PermGen &amp; Metaspace
          </h4><p>这两个就不再解释了，之前研究字符串的时候，有写过相关的：<a href="https://youyinnn.github.io/?to=post&amp;number=101">The Revelation of Java String</a></p>

          <h3>
            <a name="_root-GC Events" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            GC Events
          </h3>
          <h4>
            <a name="_root-Minor GC" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Minor GC
          </h4><p><strong>Minor GC</strong>发生在年轻代，它的概念和意图其实也就这么简单，但是还有一些细节需要我们了解一下：</p>
<ol>
<li><strong>Minor GC</strong>发生在新对象无法分配内存的时候，所以在对象创建频率高的时候，<strong>Minor GC</strong>也更频发；</li>
<li>老年代到新生代的引用会被视为<strong>GC Root</strong>，新生代到老年代的引用会被忽略掉，然后移动到Survivor区；</li>
<li>需要明确的是：<strong>Minor GC</strong>也会触发<strong>“大暂停”</strong>，会停止所有的线程，但是一般来说，如果绝大部分对象都被视为垃圾而不必进行复制的话，那么这个暂停延迟基本上可以忽略不记，反之需要在复制的过程中多消耗一些延迟</li>
</ol>

          <h4>
            <a name="_root-Major GC vs Full GC" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Major GC vs Full GC
          </h4><p>虽然没有明确的文档或者规范定义出<strong>Major GC</strong>和<strong>Full GC</strong>，但我们还是可以参照<strong>Minor GC</strong>的定义方向，定义出这两种事件：</p>
<ul>
<li><strong>Major GC</strong>：清理老年代；</li>
<li><strong>Full GC</strong>：清理整个Heap，新老年代；</li>
</ul>
<p>但我们还是不能完全将他们分开来，在很多情况下，<strong>Major GC</strong>都是由<strong>Minor GC</strong>触发的；但是另一方面，现代的GC算法比如<strong>G1</strong>，就是只进行了<strong>“部分清理”</strong>；</p>
<p>所以在这个问题上，我们的重心应该从<strong>“这个是Major GC还是Full GC”</strong>变为<strong>“是否会触发大暂停，还是这次GC能和程序同步进行”</strong></p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>