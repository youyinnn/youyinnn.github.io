<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script>
        if (location.hostname === 'youyinnn.github.io' && returnCitySN.cname === 'CHINA') {
            location.href = 'https://youyinnn.gitee.io' + location.pathname
        }
    </script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">


    <script src="/resources/resources.js"></script>
    <script src="/myjs/import.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg em-svg em-rocket"></button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <span id="slogan">
            <i id="wolf-logo" class="em-svg em-new_moon mr-4"></i>I'M BACK
        </span>
        <div id="showmore"> &gt; About Me & This Blog</div>
        <div id="showhacknical"> &gt; My Github Analysis</div>
        <div id="toarticles"> &gt; My Tech Articles</div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="series" class="unselectable">
        <span>系</span>
        <span>列</span>
        <span>文</span>
        <span>章</span>
    </div>
    <div id="seriesbox" class="unselectable">

    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistic</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Site running days:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Total article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Char count:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Category count:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tag count:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search">
            <div class="input-group-append">
                <button id="cleanbut" class="btn" type="button" title="clear search">cls</button>
                <button id="categories" class="btn" type="button">cates</button>
                <button id="tags" class="btn" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn" type="button" title="search">sch</button>
            </div>
        </div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3>
            <a name="_root-HotSpot虚拟机对象内存" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            HotSpot虚拟机对象内存
          </h3><p>深入讨论HotSpot虚拟机在Java堆中的对象分配、内存布局和对象访问的过程</p>

          <h4>
            <a name="_root-对象创建流程" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            对象创建流程
          </h4>
          <h5>
            <a name="_root-过程" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            过程
          </h5><ol>
<li><p><strong>加载类</strong></p>
<p> 当虚拟机遇到一个<strong>new指令</strong>的时候，就会检查指令参数是否能在常量池中定位到一个类的符号引用，并坚持这个符号代表的类是否已经被加载、解析和初始化过，如果没有，则需要必须进行类加载过程</p>
<p> 在类加载的过程完成后，<strong>对象所需的内存大小已经完全可以确定</strong></p>
</li>
<li><p><strong>选择内存分配算法</strong></p>
</li>
</ol>
<ul>
<li><p><strong>指针碰撞（Bump the Pointer）</strong></p>
<p>  假设<strong>Java堆的内存是绝对规整</strong>，即所有<strong>用过的内存放一边</strong>，<strong>空闲的内存放另一边</strong>，中间有一个指针作为<strong>分界点</strong>，此时对象内存分配仅是把指针向<strong>空闲方向</strong>挪动<strong>一个对象内存的距离</strong></p>
</li>
<li><p><strong>空闲列表（Free List）</strong></p>
<p>  假设<strong>Java堆内存并不是规整的</strong>，即已使用的内存和未使用的内存<strong>互相交错</strong>，虚拟机就必须维护一个<strong>列表</strong>，这个列表记录着哪些内存块是<strong>可用的</strong>，在分配的时候就在列表中找到一块<strong>足够大的空间</strong>划分给对象实例，并更新列表记录</p>
<p>因此我们选择内存分配算法的根据就是：<strong>Java堆内存的划分是否规整</strong></p>
</li>
</ul>
<ol>
<li><p><strong>选择内存分配并发问题的解决方案</strong></p>
<p> <img src="https://image.youyinnn.top/objectmemorypointer.png" alt="objectmemorypointer"></p>
<p> 如图的并发指针分配问题，我们解决这个问题有两种方式：</p>
<ol>
<li>对<strong>内存分配的动作</strong>进行<strong>同步</strong>处理</li>
<li>把<strong>内存分配的动作</strong>按照线程划分<strong>在不同的空间中进行</strong>，即每个线程在Java堆中预先分配一小块内存，这样的内存成为<strong>本地线程分配缓冲（Thread Local Allocation Buffer，TLAB）</strong>，哪个线程需要分配内存，就在哪个线程的<strong>TLAB</strong>上分配，只有当<strong>TLAB</strong>用完并分配新的<strong>TLAB</strong>的时候，再进行同步锁定</li>
</ol>
</li>
<li><p><strong>设置对象基本信息</strong></p>
<ol>
<li><p><strong>对象头（Object Header）</strong>信息的设置</p>
</li>
<li><p><strong>执行<code>init</code>方法</strong></p>
<p> 在此之前，对于JVM来说，对象已经产生了，但是对象的字段还都是0，对于Java程序来说，执行完<strong>new指令</strong>之后还得执行<strong><code>init</code>方法</strong>，初始化对象数据</p>
</li>
</ol>
</li>
</ol>

          <h4>
            <a name="_root-对象内存布局" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            对象内存布局
          </h4>
          <h5>
            <a name="_root-划分" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            划分
          </h5><ul>
<li>对象头（Header）</li>
<li>实例数据（Instance Data）</li>
<li>对齐填充（Padding）</li>
</ul>

          <h5>
            <a name="_root-1. 对象头（Header）" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            1. 对象头（Header）
          </h5><p>HotSpot的对象头分为两部分信息：</p>
<ul>
<li><p>第一部分：<strong>Mark Word</strong></p>
<p>  用于存储对象自身的<strong>运行时数据</strong>如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳</p>
</li>
<li><p>第二部分：<strong>类型指针</strong></p>
<p>  虚拟机通过这个指针来<strong>确定对象是哪个类的实例</strong>，<strong>但是</strong>并不是所有的虚拟机实现都必须在对象数据上保留类型指针，也就是查找对象所属类的元数据信息并不一定要经过类本身</p>
</li>
<li><p>第三部分：<strong>数组长度数据</strong></p>
<p>  如果对象是一个<strong>数组</strong>，则对象头还需要用一块内存来记录数组长度数据</p>
</li>
</ul>

          <h5>
            <a name="_root-2. 实例数据（Instance Data）" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            2. 实例数据（Instance Data）
          </h5><p>这一部分是对象真正存储的<strong>有效信息</strong>，也是在程序代码中锁定义的各种类型的字段内容，包括继承下来的信息</p>

          <h5>
            <a name="_root-3. 对齐填充（Padding）" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            3. 对齐填充（Padding）
          </h5><p>这部分不是必然的实现，也没有特殊含义，但是由于HotSpot VM的自动内存管理系统要求<strong>对象起始地址必须是8字节的整倍数</strong>，一个对象内存分配完之后，并不一定占8字节的整倍数空间，所以填充一些空间以补齐8字节整倍数，保证下一个对象内存分配的起始位置是8字节整倍数</p>

          <h4>
            <a name="_root-对象访问定位" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            对象访问定位
          </h4><p><strong>Java程序通过虚拟机栈上的reference数据来操作堆上的具体对象（重点）</strong></p>
<p>JVM规范<strong>只说了reference是一个指向对象的引用，但是没有说怎么引用</strong>，所以对象访问方式还是取决于虚拟机的实现，主流的实现有<strong>句柄访问</strong>和<strong>直接指针访问</strong>两种</p>

          <h5>
            <a name="_root-句柄访问" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            句柄访问
          </h5><p>如果使用这种方式，Java堆中会划分一块内存来作为<strong>句柄池</strong>，<strong>reference</strong>中存储的就是对象的<strong>句柄地址</strong>，句柄中包含了<strong>对象实例数据地址信息</strong>和<strong>类型实例数据地址信息</strong></p>
<p><img src="https://image.youyinnn.top/jubingdangwen.png" alt="jubingdangwen"></p>

          <h5>
            <a name="_root-直接指针访问" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            直接指针访问
          </h5><p>reference中存储的直接就是对象地址</p>
<p><img src="https://image.youyinnn.top/zhijiezhizhenfangwen.png" alt="zhijiezhizhenfangwen"></p>
<blockquote>
<p>直观一点解释就是</p>
<p>假如我有一个Person类：</p>
<pre><code class="language-java">public class Person{
    private static String kind = &quot;human&quot;;
    private String name;
    private Integer age;
    // ...
}</code></pre>
<p>然后有：</p>
<pre><code class="language-java">    Person jack = new Person(&quot;Jack&quot;, 21);</code></pre>
<p>这个时候，语句会有两部分，左边<code>Person</code>类型的指针<code>jack</code>，指向右边<code>Person</code>对象实例，且如果是第一次new，则会进行一系列的<code>Person</code>类的加载，这时候：</p>
<ol>
<li>在Java栈中的本地变量表（当前线程中）会存在一个reference类型指针<code>jack</code>，该指针指向一个对象的<strong>句柄地址/对象地址（4.）</strong></li>
<li>在方法区内会存在<code>Person</code>类的静态变量<code>kind</code>的数据</li>
<li>在Java堆内会存在<code>Person</code>类的静态变量<code>kind</code>的索引指针，该指针指向（2.）</li>
<li>在Java堆内会存在一个<code>Person</code>类型对象数据，数据中有<code>name=jack，age=12</code>，如果是直接指针访问，则它会包含（3.）</li>
<li>如果是句柄访问，那么在Java堆内会存在一个<strong>句柄地址</strong>，地址包含两个指针，一个指针是（3.），另一个指针指向对象实例数据（4.）</li>
</ol>
</blockquote>

          <h5>
            <a name="_root-两种方式的对比" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            两种方式的对比
          </h5><ul>
<li><strong>句柄稳定</strong>：句柄访问的好处是reference中存储的是稳定的句柄地址，<strong>对象被移动的时候（特别是垃圾回收的时候）</strong>，只需要改句柄指针就好了，reference不需要修改</li>
<li><strong>直接更快</strong>：节省了多一次指针定位的开销，对象的访问在Java中很频繁，所以指针定位开销也是较为可观的执行成本</li>
<li><strong>HotSpot用的是直接指针访问</strong></li>
</ul>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>