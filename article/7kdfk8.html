<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/jump-1.4.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/img/favicon.ico" />
    <link rel="icon" href="/img/favicon.ico" type="image/ico"/>
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">ğŸš€</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">ğŸŒ‘</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="e25a21eb">Introduction</h3><blockquote>
<p>äº‹å‰åæ§½ï¼š<em>Doug Lea</em>è€çˆ·å­çš„æ³¨é‡Šå¯çœŸéš¾è¯»ï¼Œä¹Ÿè®¸æ˜¯æˆ‘è‹±è¯­å¤ªèœé¸¡äº†- -ï¼ˆæœ¬æ¥è¿˜æŒºè‡ªä¿¡çš„ï¼Œç°åœ¨å“­ç€å­¦è‹±è¯­ï¼‰</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥Javaå¹¶å‘ç¼–ç¨‹çš„ä¸€ä¸ªå´­æ–°çš„é˜¶æ®µ</p>
<p>å‰é¢æˆ‘ä»¬å¯¹äºé”çš„å®ç°å’ŒåŒæ­¥çš„ç¼–ç¨‹ï¼Œéƒ½æ˜¯åŸºäº<code>synchronized</code>å…³é”®å­—çš„å®ç°ï¼Œç°åœ¨å¼€å§‹æ¥è§¦åˆ°çš„ï¼Œæ˜¯Javaå¹¶å‘åŒ…ä¸­æä¾›çš„é”ç›¸å…³çš„APIï¼Œé¦–å…ˆå¯ä»¥äº†è§£åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡APIçš„æ–¹å¼å»å®ç°<strong>â€œè·å–é”â€</strong>å’Œ<strong>â€œé‡Šæ”¾é”â€</strong>ï¼Œä»è€Œæ›´çµæ´»çš„å»è¿›è¡Œå¹¶å‘ç¼–ç¨‹</p>
<p>è‡³æ­¤ï¼Œä»¥åæˆ‘ä»¬å†è°ˆèµ·<strong>â€œJavaä¸­çš„é”â€</strong>ï¼Œå®ƒå¯èƒ½æŒ‡çš„æ˜¯å¤šä¸ªæ„ä¹‰ä¸Šçš„ï¼Œè®¨è®ºä¹‹å‰å…ˆè¦æ˜ç¡®ä¸€ä¸ªæ–¹å‘ï¼š</p>
<ul>
<li><code>synchronized</code>/<code>volatile</code>å…³é”®å­—çš„ä½¿ç”¨</li>
<li>é”çš„å‡ ç§<strong>ç­‰çº§</strong>å’ŒåŒºåˆ«</li>
<li>é”çš„å‡ ç§<strong>ç±»å‹</strong>å’Œä½¿ç”¨åœºæ™¯</li>
<li><strong>Lock API</strong>çš„ä½¿ç”¨ä»¥åŠå’Œ<code>synchronized</code>çš„åŒºåˆ«</li>
</ul>

          <h3 id="5d3f0954">Lock æ¥å£</h3><p>åœ¨Lockä¹‹å‰ï¼ŒJavaæ˜¯é <code>synchronized</code>å…³é”®å­—å»å®ç°é”çš„ï¼ŒJava5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£</p>
<p>å®ƒæä¾›äº†åŒæ­¥åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨è€…<strong>æ˜¾å¼</strong>åœ°å»è·å–é”å’Œé‡Šæ”¾é”ï¼š</p>
<pre><code class="language-java">Lock lock = new ReentrantLock();
lock.lock();
try {}
finally { // ä¿è¯è·å–é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾æ‰
    lock.unlock();
}</code></pre>
<p>è™½ç„¶ä¸æ¯”å…³é”®å­—ä¾¿æ·ï¼Œä½†æ˜¯å®ƒçš„ä½¿ç”¨éå¸¸çµæ´»ï¼Œä¸ä¸€å®šè¦å…ˆè·å–é”æ‰èƒ½å¤Ÿé‡Šæ”¾é”ï¼Œæ‹¥æœ‰äº†æ›´æ–¹ä¾¿çš„å¯æ“ä½œæ€§ã€å¯ä¸­æ–­æ€§å’Œ<strong>è¶…æ—¶è·å–é”</strong>ç­‰å…³é”®å­—ä¸å…·å¤‡çš„ç‰¹ç‚¹</p>
<table>
<thead>
<tr>
<th align="center">ç‰¹æ€§</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">éé˜»å¡è·å–é”</td>
<td align="center">æ— è®ºæœ‰æ²¡æœ‰è·å–æˆåŠŸï¼Œéƒ½ä¼šä»è·å–åŠ¨ä½œè¿”å›ï¼›</td>
</tr>
<tr>
<td align="center">èƒ½å¤Ÿè¢«ä¸­æ–­åœ°è·å–é”</td>
<td align="center">å’Œ<code>synchronized</code>ä¸åŒï¼Œçº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼Œå½“è·å–åˆ°é”çš„çº¿ç¨‹è¢«ä¸­æ–­çš„æ—¶å€™ï¼Œä¸­æ–­å¼‚å¸¸ä¼šæŠ›å‡ºï¼ŒåŒæ—¶é‡Šæ”¾é”ï¼›</td>
</tr>
<tr>
<td align="center">è¶…æ—¶è·å–</td>
<td align="center">åœ¨æŒ‡å®šçš„æ—¶é—´å†…è·å–åˆ°é”ï¼Œå¦åˆ™ä»è·å–åŠ¨ä½œè¿”å›ï¼›</td>
</tr>
</tbody></table>
<p>ä¸Šé¢è¿™ä¸‰ä¸ªç‚¹éƒ½æœ‰ä¸€äº›confuseçš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸€ä¸€å»è§£å¼€ï¼Œé¦–å…ˆæˆ‘ä»¬çœ‹ç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥éªŒè¯ä¸€ä¸‹ä¹‹å‰ä½¿ç”¨<code>synchronized</code>çš„æ—¶å€™çš„ä¸€ä¸ªç»†èŠ‚ï¼š<code>synchronized</code>ä¸ä¸­æ–­</p>
<pre><code class="language-java">public static void main(String[] args) throws InterruptedException {
    String lockA = &quot;A&quot;;
    Thread t1 = new Thread(() -&gt; {
        synchronized (lockA) {
            System.out.println(&quot;T1 get LockA&quot;);
            while (true) {
            }
        }
    });
    Thread t2= new Thread(() -&gt; {
        try {
            TimeUnit.SECONDS.sleep(2);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(&quot;T2 trying to get LockA&quot;);
        synchronized (lockA) {
            System.out.println(&quot;T2 get LockA&quot;);
        }
    });
    t1.start();
    t2.start();
    TimeUnit.SECONDS.sleep(3);
    while (t2.isAlive() &amp;&amp; t1.isAlive()) {
        TimeUnit.MILLISECONDS.sleep(300);
        if (!t1.isInterrupted()) {t1.interrupt();}
        if (!t2.isInterrupted()) {t2.interrupt();}
        System.out.println(&quot;T1 Alive: &quot; + t1.isAlive() + &quot;, isInterrupted: &quot; + t1.isInterrupted() + &quot;, State: &quot; + t1.getState());
        System.out.println(&quot;T2 Alive: &quot; + t2.isAlive() + &quot;, isInterrupted: &quot; + t2.isInterrupted() + &quot;, State: &quot; + t2.getState());
    }
}</code></pre>
<pre><code class="language-java">T1 get LockA
T2 trying to get LockA
T1 Alive: true, isInterrupted: true, State: RUNNABLE
T2 Alive: true, isInterrupted: true, State: BLOCKED
T1 Alive: true, isInterrupted: true, State: RUNNABLE
T2 Alive: true, isInterrupted: true, State: BLOCKED
// ....</code></pre>
<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨<code>synchronized</code>çš„è¿‡ç¨‹ä¸­ï¼ŒT2æ˜¯ç­‰å¾…è·å–é”è¢«BLOCKEDä½çš„çº¿ç¨‹ï¼Œè¿™æ—¶å€™æ˜¯æ— æ³•å“åº”ä¸­æ–­çš„ï¼Œ<strong>å³ä½¿çº¿ç¨‹çš„å·²ç»æ‰“äº†ä¸­æ–­æ ‡å¿—ï¼</strong>è€Œåœ¨T1ä¸­ï¼Œæ˜¯å¯ä»¥æ ¹æ®ä¸­æ–­æ ‡å¿—å»å“åº”ä¸­æ–­çš„ï¼Œæˆ–è€…èƒ½å¤ŸçŸ­ç¡çœ å»å“åº”ä¸­æ–­å¼‚å¸¸ï¼›</p>
<p>ä¹Ÿå°±æ˜¯ï¼Œåœ¨<code>synchronized</code>å¤–é¢BLOCKEDä½çš„çº¿ç¨‹ï¼š<strong>åªèƒ½æ˜¯é˜»å¡ï¼›æ— æ³•è¢«ä¸­æ–­ï¼›æ²¡æœ‰è¶…æ—¶ï¼›</strong></p>
<p>è€ŒLockå°±æ›´ä¸ºçµæ´»</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•åç§°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>void lock()</td>
<td>ç­‰é˜»å¡è·å–é”ï¼Œè·å–åˆ°é”ä¹‹åï¼Œä»è¯¥æ–¹æ³•è¿”å›ï¼›å¦åˆ™ä¸€ç›´åœ¨è¯¥æ–¹æ³•ä¸­ç­‰å¾…ï¼ˆæ­¤æ—¶çº¿ç¨‹çš„çŠ¶æ€æ˜¯WATINGï¼‰</td>
</tr>
<tr>
<td>void lockInterruptibly() <code>throws InterruptedException</code></td>
<td>å¯ä¸­æ–­åœ°è·å–é”ï¼Œåœ¨é”çš„è·å–è¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥ä¸­æ–­è¿™ä¸ªè¿‡ç¨‹</td>
</tr>
<tr>
<td>boolean tryLock()</td>
<td>éé˜»å¡å¼åœ°è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œè·å–å¤±è´¥ï¼Œåˆ™è¿”å›false</td>
</tr>
<tr>
<td>boolean tryLock(long time, TimeUnit unit) <code>throws InterruptedException</code></td>
<td>è¶…æ—¶è·å–ï¼šè‹¥åœ¨é™å®šæ—¶é—´å†…è·å–åˆ°é”ï¼Œåˆ™è¿”å›trueï¼›è‹¥è·å–è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼›è‹¥è¶…æ—¶ï¼Œåˆ™è¿”å›false</td>
</tr>
<tr>
<td>void unlock()</td>
<td>é‡Šæ”¾é”</td>
</tr>
<tr>
<td>Condition newCondition()</td>
<td>è·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ï¼Œæ”¹ç»„ä»¶å’Œå½“å‰çš„é”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹åªæœ‰è·å–åˆ°é”äº†ï¼Œæ‰èƒ½è°ƒç”¨æ”¹ç»„ä»¶çš„<code>wait()</code>æ–¹æ³•</td>
</tr>
</tbody></table>
<p>çœ‹äº†ä¸‹ä¸Šé¢çš„APIï¼Œæˆ‘ä»¬å¯¹äºLockå’Œ<code>synchronized</code>çš„åŒºåˆ«å°±æ¸…æ¥šäº†</p>

          <h3 id="af86a087">é˜Ÿåˆ—åŒæ­¥å™¨</h3><p>Lockæ¥å£çš„å®ç°ä¾èµ–é˜Ÿåˆ—åŒæ­¥å™¨AbstractQueuedSynchronizerï¼Œå®ƒç”¨æ¥æ„å»ºåŒæ­¥æ¡†æ¶çš„åŸºç¡€</p>
<p><strong>åŸç†ï¼š</strong>å®ƒä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡æ¥è¡¨ç¤º<strong>åŒæ­¥çŠ¶æ€ï¼ˆstateï¼‰</strong>ï¼Œå¯¹é”çš„è·å–å…¶å®å°±æ˜¯å¯¹è¯¥stateçš„è·å–ï¼Œå¯¹äºåŒæ­¥çŠ¶æ€çš„è·å–å’Œæ”¹å˜ï¼ŒåŒæ­¥å™¨æä¾›äº†çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼›å¦å¤–å®ƒè¿˜é€šè¿‡ä¸€ä¸ªå†…ç½®çš„FIFOçš„é˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿã€‚</p>
<blockquote>
<p><strong>åŒæ­¥çŠ¶æ€</strong>çš„æ¦‚å¿µï¼Œå¦‚æœå­¦è¿‡æ“ä½œç³»ç»Ÿçš„éƒ½çŸ¥é“ï¼Œåœ¨PVé—®é¢˜ä¸­ä¼šæœ‰ä¸€ä¸ªå€¼æ¥ä»£è¡¨å½“å‰å¯ä»¥è®¿é—®ä¸´ç•Œèµ„æºçš„èµ„æ ¼ï¼Œè¿™é‡Œçš„åŒæ­¥çŠ¶æ€å¤§æ¦‚ä¹Ÿæ˜¯è¿™ä¹ˆä¸ªæ„æ€</p>
<p>åŸºæœ¬ä¸Šstateå¦‚æœæ˜¯0å°±ä»£è¡¨æ— æ³•è·å–ï¼Œå¦‚æœå¤§äº0å°±ä»£è¡¨èƒ½å¤Ÿè·å–ä¸€æ¬¡ï¼Œæ¯”å¦‚è¯´å¦‚æœç°åœ¨AQSçš„stateæ˜¯2ï¼Œä½ è¿˜èƒ½acquire2æ¬¡ï¼Œæ¯æ¬¡acquire(1)ï¼Œå› ä¸ºæ˜¯åªæœ‰1ä¸ªçº¿ç¨‹åœ¨acquireå˜›ï¼Œç­‰åˆ°stateä¸å¤Ÿäº†çš„æ—¶å€™ï¼Œå°±å¼€å§‹æ’é˜Ÿäº†</p>
</blockquote>
<p>åŒæ­¥å™¨çš„ä½¿ç”¨ä¸»è¦æ˜¯é€šè¿‡<strong>ç»§æ‰¿</strong>çš„æ–¹å¼ï¼Œå®ç°Lock APIçš„æ—¶å€™ï¼Œæ¨èåŒæ—¶åœ¨é‡Œé¢å†™ä¸€ä¸ªé™æ€å†…éƒ¨ç±»æ¥å®ç°åŒæ­¥å™¨ï¼ŒåŒæ­¥å™¨æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œä»…æ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾æ–¹æ³•æ¥æä¾›è‡ªå®šä¹‰ç»„ä»¶å»ä½¿ç”¨ï¼Œå¹¶ä¸”åŒæ­¥å™¨æ”¯æŒç‹¬å å¼å’Œå…±äº«å¼çš„å®ç°ï¼Œæ‰€ä»¥å®ƒå¯ä»¥ä¸ºå¤šç§ä¸åŒçš„åŒæ­¥ç»„ä»¶å»æœåŠ¡ï¼ˆ<code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ã€<code>CountDownLatch</code>ï¼‰</p>
<p>å®ƒå’ŒLockçš„å…³ç³»å°±åƒå‰åç«¯çš„å…³ç³»ä¸€æ ·ï¼š</p>
<ul>
<li>Lockæ˜¯é¢å‘é”ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…æ‰€éœ€è¦çš„é”çš„æ–¹æ³•ï¼Œéšè—äº†å®ç°ç»†èŠ‚</li>
<li>åŒæ­¥å™¨æ˜¯é¢å‘é”å®ç°è€…çš„ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹æ’é˜Ÿã€ç­‰å¾…å’Œå”¤é†’ç­‰åº•å±‚æ“ä½œ</li>
</ul>
<p><strong>é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…é”å…³æ³¨çš„é¢†åŸŸï¼Œåˆå¢å¼ºäº†é”çš„å¯æ“ä½œæ€§å’Œé™ä½äº†é”çš„å®ç°éš¾åº¦</strong></p>

          <h4 id="804b002b">æ¥å£ä¸ç¤ºä¾‹</h4><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œé”çš„å®ç°è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªåŒæ­¥å™¨çš„è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä¼šè°ƒç”¨è¿™ä¸ªåŒæ­¥å™¨æä¾›çš„åŒæ­¥æ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•å°±æ˜¯å®ç°è€…é‡å†™çš„æ–¹æ³•</p>

          <h5 id="c957f9ea">çŠ¶æ€ç›¸å…³æ–¹æ³•</h5><p>é‡å†™æ¨¡æ¿æ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°åŒæ­¥å™¨æä¾›çš„çŠ¶æ€ç›¸å…³æ–¹æ³•</p>
<ul>
<li><code>getState()</code>ï¼šè·å–åŒæ­¥çŠ¶æ€</li>
<li><code>setState()</code>ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€</li>
<li><code>compareAndSetState()</code>ç”¨CASè®¾ç½®åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¿è¯è®¾ç½®åŠ¨ä½œçš„åŸå­æ€§</li>
</ul>

          <h5 id="d372d452">åŒæ­¥å™¨å¯é‡å†™çš„æ–¹æ³•</h5><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>protected boolean tryAccquire(int arg)</code></td>
<td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æŸ¥è¯¢åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åå†ä½¿ç”¨CASè®¾ç½®æ–°çš„åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>protected boolean tryRelease(int arg)</code></td>
<td>ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>protected int tryAcquireShared(int arg)</code></td>
<td>å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè‹¥è¿”å›å¤§äº0çš„å€¼åˆ™è¡¨ç¤ºè·å–æˆåŠŸï¼Œå¦åˆ™è·å–å¤±è´¥</td>
</tr>
<tr>
<td><code>protected int tryReleaseShared(int arg)</code></td>
<td>å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>protected boolean isHeldExclusively()</code></td>
<td>å½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ï¼Œä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹ç‹¬å </td>
</tr>
</tbody></table>

          <h5 id="43757738">åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•</h5><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>void acquire(int arg)</code></td>
<td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœåŒæ­¥çŠ¶æ€è·å–æˆåŠŸï¼Œåˆ™ä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨é‡å†™çš„<code>tryAcquire</code>æ–¹æ³•</td>
</tr>
<tr>
<td><code>void acquireInterruptibly(int arg)</code></td>
<td>å’Œ<code>acquire</code>ç›¸åŒï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹å¦‚æœæ²¡è·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶å€™ï¼Œè¿™æ—¶å€™ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå®ƒå°±ä¼šä»é˜Ÿåˆ—ä¸­é€€å‡ºå¹¶ä¸”æŠ›å‡ºå¼‚å¸¸</td>
</tr>
<tr>
<td><code>boolean tryAcquireNanos(int arg, long nanos)</code></td>
<td>åœ¨<code>acquireInterruptibly</code>çš„åŸºç¡€ä¸ŠåŠ äº†è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœåœ¨é™æ—¶å†…è·å–åˆ°åŒæ­¥çŠ¶æ€äº†å°±è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
</tr>
<tr>
<td><code>void acquireShared(int arg)</code></td>
<td>å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯åŒä¸€æ—¶é—´å…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>void acquireSharedInterruptibly(int arg)</code></td>
<td>å…±äº«å¼å¯ä¸­æ–­è·å–åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>boolean acquireSharedNanos(ing arg, long nanos)</code></td>
<td>å…±äº«å¼å¯ä¸­æ–­æœ‰è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ï¼Œé™æ—¶å†…è·å–åˆ°å°±è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
</tr>
<tr>
<td><code>boolean release(int arg)</code></td>
<td>ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå¹¶å”¤é†’åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</td>
</tr>
<tr>
<td><code>boolean releaseShared(int arg)</code></td>
<td>å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td><code>Collection&lt;Thread&gt; getQueuedThreads()</code></td>
<td>è·å–ç­‰å¾…åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹é›†åˆ</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¨¡æ¿æ–¹æ³•åˆ†ä¸ºä¸‰ç±»ï¼šç‹¬å å¼è·å–å’Œé‡Šæ”¾ã€å…±äº«å¼è·å–å’Œæ˜¯å¦ã€åŒæ­¥é˜Ÿåˆ—çº¿ç¨‹é›†åˆ</p>

          <h3 id="8f5b4a8a">å°è¯•å®ç°ä¸€ä¸ªç‹¬å é”</h3><pre><code class="language-java">class Mutex implements Lock {
    static class Q extends AbstractQueuedSynchronizer {
        // æŸ¥çœ‹æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€
        @Override
        protected boolean isHeldExclusively() {return getState() == 1;}
        @Override
        public boolean tryAcquire(int acquire) {
            // çŠ¶æ€ä¸º0çš„æ—¶å€™è·å–é”
            if (compareAndSetState(0, acquire)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
        @Override
        protected boolean tryRelease(int release) {
            if (getState() == 0) {
                throw new IllegalMonitorStateException();
            }
            // é‡Šæ”¾é”å¹¶å°†çŠ¶æ€è®¾ç½®ä¸º0
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }
        // è¿”å›ä¸€ä¸ªConditionå¯¹è±¡ æ¯ä¸€ä¸ªconditionObjectéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—
        Condition newCondition() {return new ConditionObject();}
        // è¿”å›å½“å‰æŒæœ‰æœ¬é”çš„çº¿ç¨‹å¯¹è±¡
        public Thread getOwnerThread() {return getExclusiveOwnerThread();}
    }
    private final Q q = new Q();
    @Override
    public void lock() {q.acquire(1);}
    @Override
    public void lockInterruptibly() throws InterruptedException {
        q.acquireInterruptibly(1);
    }
    @Override
    public boolean tryLock() {return q.tryAcquire(1);}
    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return q.tryAcquireNanos(1, unit.toNanos(time));
    }
    @Override
    public void unlock() {q.release(1);}
    @Override
    public Condition newCondition() {return q.newCondition();}
    // å¯ä»¥é¢å¤–é™„åŠ çš„å®ç°
    public boolean isLocked() {return q.isHeldExclusively();}
    public boolean hasQueuedThreads() {return q.hasQueuedThreads();}
    public Thread getExclusiveOwnerThread() {return q.getOwnerThread();}
}</code></pre>
<p>æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªMutexï¼Œé¦–å…ˆå®ç°<code>Lock</code>æ¥å£ï¼Œç„¶åå†™ä¸€ä¸ªå†…éƒ¨ç±»å¹¶ç»§æ‰¿<code>AbstractQueuedSynchronizer</code>ï¼Œåœ¨Mutexä¸­å®ä¾‹åŒ–ä¸€ä¸ªåŒæ­¥å™¨å¯¹è±¡ï¼Œå¹¶æŠŠåŒæ­¥å™¨å¯¹è±¡çš„æ–¹æ³•ä»£ç†ä¸ºï¼ŒLockæ¥å£çš„æ–¹æ³•çš„å®ç°</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>AbstractQueuedSynchronizer</code>ç±»æœ¬èº«å°±æä¾›äº†å¾ˆå¤šæ–¹æ³•ä½œä¸ºå®ç°åŒæ­¥ç»„ä»¶çš„æœ‰åŠ›å·¥å…·ï¼Œæ¯”å¦‚åœ¨<code>tryAcquire(int acquire)</code>æ–¹æ³•çš„å®ç°é‡Œï¼Œå°±ç”¨åˆ°äº†<code>compareAndSetState</code>å°è¯•è®¾ç½®åŒæ­¥çŠ¶æ€ï¼Œå¹¶ä¸”å¦‚æœè®¾ç½®æˆåŠŸçš„è¯ï¼Œå°±ä»£è¡¨å½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°è¯¥é”äº†ï¼Œéšåå°±æŠŠå½“å‰çº¿ç¨‹å’Œè¯¥åŒæ­¥å™¨è¿›è¡Œç»‘å®šï¼Œå³é€šè¿‡<code>setExclusiveOwnerThread</code>æ–¹æ³•å°†è¯¥çº¿ç¨‹è®¾ç½®ä¸ºé”çš„æŒæœ‰è€…</p>
<p>å…¶ä»–è¯¸å¦‚è·å–Queueä¸­çš„çº¿ç¨‹é›†åˆã€åˆ¤æ–­æ˜¯é”æ˜¯å¦è¢«é”ä¸Šã€è·å–é”çš„æŒæœ‰çº¿ç¨‹ç­‰ç­‰è¿™äº›æ–¹æ³•ï¼Œéƒ½èƒ½é€šè¿‡åŒæ­¥å™¨æä¾›çš„æ–¹æ³•å»çµæ´»å®ç°ï¼Œåœ¨è¿™æ ·çµæ´»çš„åŒæ­¥å™¨çš„å¸®åŠ©ä¸‹ï¼Œèƒ½å¤Ÿå®ç°ç¬¦åˆå¾ˆå¤šåœºæ™¯çš„åŒæ­¥ç»„ä»¶</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¿˜æ³¨æ„åˆ°æœ‰ä¸€ä¸ª<code>newCondition</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡æœ‰ä»€ä¹ˆç”¨ï¼Œæˆ‘ä»¬ä»¥åå†æ…¢æ…¢ç ”ç©¶</p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>