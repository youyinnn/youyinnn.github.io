<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script>
        if (location.hostname === 'youyinnn.github.io' && returnCitySN.cname === 'CHINA') {
            location.href = 'https://youyinnn.gitee.io' + location.pathname
        }
    </script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@master/img/favicon.ico" />
    <link rel="stylesheet" href="/mycss/style.css">


    <script src="/resources/resources.js"></script>
    <script src="/myjs/import.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg em-svg em-rocket"></button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <span id="slogan">
            <i id="wolf-logo" class="em-svg em-new_moon mr-4"></i>I'M BACK
        </span>
        <div id="showmore"> &gt; About Me & This Blog</div>
        <div id="showhacknical"> &gt; My Github Analysis</div>
        <div id="toarticles"> &gt; My Tech Articles</div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="series" class="unselectable">
        <span>系</span>
        <span>列</span>
        <span>文</span>
        <span>章</span>
    </div>
    <div id="seriesbox" class="unselectable">

    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistic</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Site running days:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Total article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Char count:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Category count:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tag count:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search">
            <div class="input-group-append">
                <button id="cleanbut" class="btn" type="button" title="clear search">cls</button>
                <button id="categories" class="btn" type="button">cates</button>
                <button id="tags" class="btn" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn" type="button" title="search">sch</button>
            </div>
        </div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3>
            <a name="_root-前言" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            前言
          </h3><p>前两篇基本说了线程的基本概念和基本使用，这回说说Java并发编程第三坎，关于锁的好多基本概念的提前了解</p>
<p>在讲锁之前，我们还需要介绍一个很重要的原理——CAS（Compare And Swap）操作，这个操作是保证并发过程中每个操作具有<strong>“原子性”</strong>的利器</p>
<ul>
<li><strong>关键概念说明：</strong>临界区、排他锁、共享式锁、Java对象头</li>
<li><strong>什么是CAS操作：</strong>原子性、CAS</li>
</ul>
<p>暂时只有这些概念，如果有什么提前概念我会继续补充</p>
<hr>

          <h3>
            <a name="_root-关键概念说明" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            关键概念说明
          </h3>
          <h4>
            <a name="_root-临界区" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            临界区
          </h4><p>在操作系统的解释上，临界区代表的是<strong>“不允许多个进程访问的资源叫临界资源，而访问临界资源的代码段叫临界区”</strong></p>
<p>而在这里，我们可以笼统地说：<strong>锁包括的范围就是临界区，临界区的资源需要保证内存可见性，需要对所有线程任何时刻都保持一致性</strong></p>

          <h4>
            <a name="_root-排他锁" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            排他锁
          </h4><p>也就是独占式锁，一旦一个线程获取到了这个锁而单独进入临界区，其他线程在拿锁线程没放锁之前只能在锁外阻塞。</p>

          <h4>
            <a name="_root-共享式锁" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            共享式锁
          </h4><p>所谓共享式锁就是，可以有多个线程同时获取到锁而共同进入临界区，一般这部分线程都有着共同的特性，而没有这些特性的其他线程则在锁外阻塞，需要保证的是持有锁的这些线程对临界区的操作要同步，也就是说要么这些线程只能读，这些一般这个时候临界区就失去了临界区的意义，要么这些线程在临界区内进行的写操作之间也要保持同步，但是这没有太大的意义</p>
<p>举个例子，读者/写者模式中，同一篇文章允许多个读者同时读，新写者阻塞直到没有读者读（看似好像和实际遇到的读写者模式不大一样），对于读者之间来说，这就是<strong>共享式锁</strong>，但是同一时刻只能有一个写者写，新的写者和新的读者只能阻塞，对于写者之间来说，这就是<strong>独占式锁</strong></p>
<p>在上面的例子中，读者线程之间共性就是只能读取临界资源，同一时刻只存在读取操作的话，不会造成内存可见性问题，所以读者线程可以共享（关于什么是<strong>内存可见性问题</strong>，在内存模型的部分会讲解到，这里就简单理解为<strong>脏读问题</strong>）</p>
<p>对于例子中读者可以阻塞写者的说法，有的人可能想不通，我们投入到场景中去看：</p>
<blockquote>
<ul>
<li>Github上有一篇issue，你可以看到，这算是<strong>“读a”</strong></li>
<li>你可以编辑，这算是<strong>“写a”</strong></li>
<li>但实际上的临界资源是存放在Github服务器上的，这里才真正运用到了<strong>读写者模式</strong>，我们刷一个issue页的时候，首先请求到服务端，服务端对临界资源进行<strong>“读b”</strong>操作</li>
<li>在无阻塞的情况下，<strong>“读b”</strong>操作把读出的临界资源issue内容，复制了一份，响应给请求方浏览器，所以我们在浏览器上读取到的资源，并不是临界资源，而是临界资源在<strong>“读b”</strong>操作中复制出来的副本而已</li>
<li>所以<strong>“读a”</strong>操作其实读的是副本内容并不存在临界资源的抢夺</li>
<li>同理， 我们<strong>“写a”</strong>也是对副本进行写操作，然后把写好的内容发送给服务端，由服务端对临界资源进行<strong>“写b”</strong>操作，这时如果有其他的<strong>“读b”</strong>操作，<strong>“写b”</strong>会阻塞</li>
</ul>
</blockquote>

          <h4>
            <a name="_root-Java对象头" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Java对象头
          </h4><p>用于存储Java对象的一些控制信息，在并发的过程中，锁的记录会经常性地和对象头中的一些标志位打交道，特别是在使用synchronized关键字的时候，具体的位置是放在对象头的<strong>Mark Word</strong>内容当中</p>
<p>所以对于Java来说，synchronized用的锁是存在<strong>Java对象头</strong>里的，这部分就不细说了</p>

          <h3>
            <a name="_root-CAS操作" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            CAS操作
          </h3>
          <h5>
            <a name="_root-什么是CAS" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            什么是CAS
          </h5><p>CAS即<strong>Compare And Swap</strong>，比较并交换，它的思想是输入两个值，一个旧值（期望的操作前的值）和一个替换旧值的新值，在操作期间先比较旧值和新值，看是否发生了变化，如果<strong>没有变化</strong>才将旧值换成新值，如果发生了变化则不替换</p>

          <h5>
            <a name="_root-什么是原子性" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            什么是原子性
          </h5><p>原子（atomic）的本意是“不能被分割的最小粒子”，而原子操作就是“不可被中断的一个或者一系列操作”，但是在多处理器中实现原子操作是有点困难的</p>

          <h5>
            <a name="_root-处理器如何实现原子操作" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            处理器如何实现原子操作
          </h5><ul>
<li><strong>处理器会自动保证：</strong>对内存的操作是原子的，则当一个处理器处理一个字节的时候，其他处理器不能访问这个字节的内存地址</li>
<li><strong>锁总线：</strong>当一个处理器要操作一个共享变量的时候，会发出一个LOCK #信号，其他处理器对该变量的操作会阻塞</li>
<li><strong>锁缓存：</strong>参考缓存一致性</li>
</ul>

          <h5>
            <a name="_root-Java中的CAS" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            Java中的CAS
          </h5><p>Java SE1.5开始，JDK并发包就提供了一些原子操作的更新器，比如<code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>等，这些原子包装类还提供了原子的自增自减等方法</p>

          <h5>
            <a name="_root-CAS的三大问题" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            CAS的三大问题
          </h5><ol>
<li><strong>ABA问题：</strong>如果一个值原来是A，变成了B，然后又变回了A，实际上有变化，但是CAS是检测不到变化的，要解决这个问题，可以在变量前面追加版本号，每次变化则版本号加1，在我看来这可以说是双重CAS，一个只负责给版本号加一，一个复杂监控整个变量值的变化，这样就变成了：1A-2B-3A</li>
<li><strong>自旋消耗：</strong>使用CAS一般是搭配上<strong>自旋（即死循环）</strong>来使用，如果长时间自旋CAS成功，则会大量消耗CPU，这个问题并不好解决</li>
<li><strong>只能保证一个变量的原子值：</strong>如果要对多个变量同时保证原子操作，有两种方式，一种是将多个变量聚合成一个变量，第二个是通过锁操作</li>
</ol>

          <h5>
            <a name="_root-CAS和Java中锁的关系" class="reference-link" target="_blank">
              <span class="header-link"></span>
            </a>
            CAS和Java中锁的关系
          </h5><p>JVM中实现了许多锁机制，但是除了偏向锁，其他锁的实现方式几乎都用了循环CAS，<strong>即当一个线程要进入同步块的时候，使用循环CAS的方式来获取锁，当它要退出锁的时候，使用循环CAS来释放锁</strong></p>
<hr>
<p>坐骑已经找到了，皮皮猪，我们走！</p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>